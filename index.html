<!DOCTYPE html>
<!--
  App: Satyam Refinery â€“ Vendor Silver Melting & Billing System
  Version: 3.8.4 (Fixed JavaScript Variable Declaration Conflict)

  Key Improvements (3.8.4):
  1. JS FIX: Removed duplicate const declarations and redundant listeners from the bottom of the body.
  2. JS FIX: Integrated mobile sidebar toggle logic (using .open class) correctly into the main script's event listeners block where the variables are globally defined.
-->
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- START: Mobile/PWA Enhancements -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#2563eb">
    <link rel="manifest" href="manifest.json">
    <!-- END: Mobile/PWA Enhancements -->
    <title>Satyam Refinery Dashboard</title>

    <!-- 1. TailwindCSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- 2. Chart.js via CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- 3. PDF Exporter (html2canvas & jsPDF) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>


    <!-- 4. Lucide Icons via CDN -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>

    <!-- 5. Custom Font (Poppins & Inter for secondary) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- 6. THREE.js for subtle 3D background effects (optional thematic animation) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <!-- 7. Custom Styles -->
    <style>
        /* Optional: Smooth Mobile Experience (Step 5) */
        html {
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }
        
        /* Custom scrollbar for light theme only */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #bdbdbd; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }

        /* Font and base colors */
        body {
            font-family: 'Poppins', sans-serif;
            font-size: 16px;
            line-height: 1.6;
            letter-spacing: 0.01em;
        }
        h1, h2, h3, h4, h5, h6 { color: #111827; font-family: 'Poppins', sans-serif; }
        .text-gray-900 { color: #111827; }
        .text-gray-800, .text-gray-700 { color: #4b5563; } /* Increased contrast for body text */
        .font-inter { font-family: 'Inter', sans-serif; }

        /* Active sidebar link style */
        .sidebar-link.active {
            background-color: #2563eb;
            color: #ffffff !important;
            font-weight: 600;
            box-shadow: 0 6px 16px rgba(37, 99, 235, 0.3);
        }
        .sidebar-link.active i {
            color: #ffffff !important;
        }

        /* Premium Hover effects for cards/sections */
        .hover-lift {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            will-change: transform, box-shadow;
        }
        .hover-lift:hover {
            transform: translateY(-5px) scale(1.01);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15); /* Stronger shadow on hover */
        }
        .card-shadow {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05), 0 10px 15px rgba(0, 0, 0, 0.05);
        }

        /* Modal styles */
        .modal { transition: opacity 0.25s ease; }
        .modal.open .modal-content { transform: translateY(0) scale(1); }
        .modal.open { opacity: 1; }

        /* Loading Spinner */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #2563eb;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Page fade-in animation */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .page-content {
            animation: fadeIn 0.4s ease-out;
        }

        /* Sidebar styles */
        .sidebar-expanded { width: 18rem; }
        .sidebar-collapsed { width: 5rem; }
        .sidebar-transition { transition: width 0.3s ease-in-out; }

        /* 3D Canvas Background */
        #three-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
        }

        /* Live Sync Indicator Pulse */
        @keyframes pulse-live {
            0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(34, 197, 94, 0); }
            100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
        }
        .live-sync-indicator {
            animation: pulse-live 1.5s infinite;
        }

        /* Watermark for Bill PDF */
        #bill-print-area::before {
            content: "SATYAM REFINERY";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-45deg);
            font-size: 4rem;
            font-weight: 700;
            color: rgba(37, 99, 235, 0.08); /* Faint blue opacity */
            pointer-events: none;
            z-index: 0;
        }
        
        /* Nav Fix: Ensure pages are hidden/shown correctly (Step 4) */
        .page-content {
          display: none;
        }
        .page-content.active {
          display: block !important;
        }

        /* =========================
           ðŸ“± Mobile Responsiveness Fix (Step 1)
           ========================= */
        @media (max-width: 768px) { 
            html, body {
                height: auto !important;
                overflow-y: auto !important;
                overflow-x: hidden !important;
            }

            /* Sidebar hidden by default, toggled by button */
            #sidebar {
                position: fixed;
                top: 0;
                left: 0;
                width: 70%;
                height: 100%;
                z-index: 9999;
                background: #fff;
                transform: translateX(-100%);
                transition: transform 0.3s ease-in-out;
            }
            #sidebar.hidden { /* Override generic hidden class if present on mobile */
                display: block !important;
            }
            #sidebar.open {
                transform: translateX(0);
            }

            /* Content wrapper fixes */
            #main-content-wrapper {
                padding-left: 0 !important;
                overflow-y: visible !important;
            }

            /* Fix page-content to scroll properly */
            .page-content {
                overflow-y: auto !important;
                max-height: none !important;
                padding-bottom: 5rem !important; /* Ensure floating button doesn't block content */
            }

            /* Cards & grids auto stack */
            .grid {
                grid-template-columns: 1fr !important;
            }

            /* Reduce padding for readability */
            .p-6, .px-8, .py-6 {
                padding: 1rem !important;
            }

            /* Table improvements */
            table {
                font-size: 14px !important;
            }
            th, td {
                padding: 8px !important;
            }
            
            /* Ensure the login screen respects the overflow fix */
            #login-screen {
                overflow-y: auto !important;
            }
            
            /* Chart container scroll (Step 2 support) */
            .chart-container {
                overflow-x: auto !important;
            }
            /* Set a min-width for the chart area so it scrolls */
             #melting-chart {
                min-width: 600px;
                width: 100%; /* Keep width calculation correct */
                height: 400px; /* Preserve height */
            }
        }
        
    </style>
</head>

<body class="h-full bg-gray-100 text-gray-800 transition-colors duration-300 overflow-hidden font-inter">

    <!-- Global Loading Spinner (for API calls) -->
    <div id="global-spinner" class="modal fixed inset-0 z-[101] flex items-center justify-center bg-black/50 opacity-0 transition-opacity duration-300 ease-in-out pointer-events-none no-print">
        <div class="spinner"></div>
    </div>

    <!-- Global Toast Notification -->
    <div id="toast-notification" class="fixed top-8 right-8 z-[100] p-4 rounded-2xl shadow-2xl text-white transition-all duration-300 translate-x-[120%]" role="alert">
        <span id="toast-message"></span>
    </div>

    <!--
    ============================================================
    LOGIN SCREEN / SIGNUP SCREEN (Luxurious Theme)
    ============================================================
    -->
    <div id="login-screen" class="hidden flex min-h-screen items-center justify-center py-12 px-4 sm:px-6 lg:px-8 relative z-10">

        <!-- Three.js 3D Background Canvas -->
        <canvas id="three-canvas"></canvas>

        <!-- Subtle Gradient Overlay -->
        <div class="absolute inset-0 bg-gradient-to-t from-blue-900/60 to-transparent z-10"></div>

        <!-- Sleek, Glassy Login Card -->
        <div class="w-full max-w-md space-y-8 z-20 backdrop-blur-xl bg-white/80 p-10 rounded-2xl shadow-2xl border border-gray-200">

            <!-- Logo and Title -->
            <div class="animate-in fade-in slide-in-from-top-10 duration-1000">
                <!-- Flame icon with a subtle gold glow color -->
                <i data-lucide="flame" class="mx-auto h-14 w-auto text-blue-600" style="filter: drop-shadow(0 0 5px rgba(255, 215, 0, 0.5));" id="login-logo"></i>

                <h2 class="mt-6 text-center text-4xl font-bold tracking-tight text-gray-900">Satyam Refinery</h2>
                <p class="text-center text-base text-gray-700 font-inter mt-1">Vendor Melting & Billing System</p>
            </div>

            <!-- Loading Spinner -->
            <div id="auth-loader" class="flex flex-col justify-center items-center pt-8 pb-4">
                <div class="spinner"></div>
                <p class="text-gray-700 text-base animate-pulse mt-4 font-inter">
                    Connecting to Refinery Network...
                </p>
            </div>

            <!-- Login Form (hidden by default) -->
            <form id="login-form" class="mt-8 space-y-6 hidden animate-in fade-in slide-in-from-bottom-10 duration-1000 delay-300" action="#" method="POST">
                <h3 class="text-center text-xl font-semibold text-gray-800">Admin Sign In</h3>
                <input type="hidden" name="remember" value="true">
                <div class="space-y-4 rounded-2xl">
                    <div>
                        <label for="login-email" class="sr-only">Email address</label>
                        <input id="login-email" name="email" type="email" autocomplete="email" required class="relative block w-full appearance-none rounded-2xl border border-gray-300 bg-white px-4 py-3 text-gray-900 placeholder-gray-500 focus:z-10 focus:border-blue-600 focus:outline-none focus:ring-blue-600 transition-all duration-200 font-inter" placeholder="Email address">
                    </div>
                    <div>
                        <label for="login-password" class="sr-only">Password</label>
                        <input id="login-password" name="password" type="password" autocomplete="current-password" required class="relative block w-full appearance-none rounded-2xl border border-gray-300 bg-white px-4 py-3 text-gray-900 placeholder-gray-500 focus:z-10 focus:border-blue-600 focus:outline-none focus:ring-blue-600 transition-all duration-200 font-inter" placeholder="Password">
                    </div>
                </div>

                <div class="flex items-center justify-end">
                    <div class="text-sm">
                        <a href="#" id="show-forgot-password" class="font-medium text-blue-600 hover:text-blue-700 font-inter transition-colors duration-200">
                            Forgot your password?
                        </a>
                    </div>
                </div>

                <div id="login-error" class="text-sm text-red-600 font-inter"></div>
                <div>
                    <button type="submit" id="login-button" class="group relative flex w-full justify-center rounded-2xl border border-transparent bg-blue-600 py-3 px-4 text-base font-medium text-white shadow-lg hover:bg-blue-700 transition-all duration-200 hover:scale-[1.02]">
                        Sign in
                    </button>
                </div>
                <p class="text-center text-sm text-gray-700 font-inter">
                    <a href="#" id="show-signup" class="font-medium text-blue-600 hover:text-blue-700 transition-colors duration-200">
                        Don't have an account? Sign up
                    </a>
                </p>
            </form>

            <!-- Signup Form (hidden by default) -->
            <form id="signup-form" class="mt-8 space-y-6 hidden animate-in fade-in slide-in-from-bottom-10 duration-1000 delay-300" action="#" method="POST">
                <h3 class="text-center text-xl font-semibold text-gray-800">Create Admin Account</h3>
                <div class="space-y-4 rounded-2xl">
                    <div>
                        <label for="signup-name" class="sr-only">Full Name</label>
                        <input id="signup-name" name="name" type="text" autocomplete="name" required class="relative block w-full appearance-none rounded-2xl border border-gray-300 bg-white px-4 py-3 text-gray-900 placeholder-gray-500 focus:z-10 focus:border-blue-600 focus:outline-none focus:ring-blue-600 font-inter" placeholder="Full Name">
                    </div>
                    <div>
                        <label for="signup-email" class="sr-only">Email address</label>
                        <input id="signup-email" name="email" type="email" autocomplete="email" required class="relative block w-full appearance-none rounded-2xl border border-gray-300 bg-white px-4 py-3 text-gray-900 placeholder-gray-500 focus:z-10 focus:border-blue-600 focus:outline-none focus:ring-blue-600 font-inter" placeholder="Email address">
                    </div>
                    <div>
                        <label for="signup-password" class="sr-only">Password</label>
                        <input id="signup-password" name="password" type="password" autocomplete="new-password" required class="relative block w-full appearance-none rounded-2xl border border-gray-300 bg-white px-4 py-3 text-gray-900 placeholder-gray-500 focus:z-10 focus:border-blue-600 focus:outline-none focus:ring-blue-600 font-inter" placeholder="Password (min. 6 characters)">
                    </div>
                </div>
                <div id="signup-error" class="text-sm text-red-600 font-inter"></div>
                <div>
                    <button type="submit" id="signup-button" class="group relative flex w-full justify-center rounded-2xl border border-transparent bg-green-600 py-3 px-4 text-base font-medium text-white shadow-lg hover:bg-green-700 transition-all duration-200 hover:scale-[1.02]">
                        Sign up
                    </button>
                </div>
                <p class="text-center text-sm text-gray-700 font-inter">
                    <a href="#" id="show-login" class="font-medium text-blue-600 hover:text-blue-700 transition-colors duration-200">
                        Already have an account? Sign in
                    </a>
                </p>
            </form>

            <!-- Forgot Password Form (hidden by default) -->
            <form id="forgot-password-form" class="mt-8 space-y-6 hidden animate-in fade-in slide-in-from-bottom-10 duration-1000 delay-300" action="#" method="POST">
                <h3 class="text-center text-xl font-semibold text-gray-800">Reset Password</h3>
                <p class="text-center text-sm text-gray-700 font-inter">Enter your email and we'll send you a link to reset your password.</p>
                <div class="space-y-4 rounded-2xl">
                    <div>
                        <label for="forgot-email" class="sr-only">Email address</label>
                        <input id="forgot-email" name="email" type="email" autocomplete="email" required class="relative block w-full appearance-none rounded-2xl border border-gray-300 bg-white px-4 py-3 text-gray-900 placeholder-gray-500 focus:z-10 focus:border-blue-600 focus:outline-none focus:ring-blue-600 font-inter" placeholder="Email address">
                    </div>
                </div>
                <div id="forgot-error" class="text-sm text-red-600 font-inter"></div>
                <div id="forgot-success" class="text-sm text-green-600 font-inter"></div>
                <div>
                    <button type="submit" id="forgot-button" class="group relative flex w-full justify-center rounded-2xl border border-transparent bg-blue-600 py-3 px-4 text-base font-medium text-white shadow-lg hover:bg-blue-700 transition-all duration-200 hover:scale-[1.02]">
                        Send Reset Link
                    </button>
                </div>
                <p class="text-center text-sm text-gray-700 font-inter">
                    <a href="#" id="show-login-from-forgot" class="font-medium text-blue-600 hover:text-blue-700 transition-colors duration-200">
                        Back to Sign In
                    </a>
                </p>
            </form>

        </div>
    </div>

    <!--
    ============================================================
    MAIN APPLICATION (HIDDEN BY DEFAULT)
    ============================================================
    -->
    <div id="main-app" class="hidden h-full relative overflow-hidden">
        <!-- Sidebar (desktop view) -->
        <div id="sidebar" class="fixed inset-y-0 z-50 flex flex-col border-r border-gray-200 bg-white no-print sidebar-transition sidebar-expanded sm:sidebar-expanded">
            <!-- Sidebar header -->
            <div class="flex flex-shrink-0 items-center h-16 px-6 border-b border-gray-200">
                <i data-lucide="flame" class="h-8 w-auto text-blue-600"></i>
                <span id="sidebar-title" class="ml-3 text-xl font-semibold text-gray-900">Refinery System</span>
            </div>

            <!-- Navigation -->
            <div class="flex flex-1 flex-col overflow-y-auto pt-5 pb-4">
                <nav class="flex-1 space-y-2 px-4" aria-label="Sidebar">
                    <!-- Nav items will be dynamically injected here -->
                </nav>
            </div>

            <!-- User profile / Logout -->
            <div class="flex flex-shrink-0 border-t border-gray-200 p-4">
                <div class="flex-shrink-0 w-full">
                    <div class="flex items-center">
                        <div>
                            <img id="user-avatar" class="inline-block h-10 w-10 rounded-full" src="https://placehold.co/40x40/2563eb/ffffff?text=A" alt="Admin">
                        </div>
                        <div class="ml-3">
                            <p id="user-name" class="text-base font-medium text-gray-900">Administrator</p>
                            <p id="user-role" class="text-xs font-inter text-gray-500">User ID: <span id="user-id-display">...</span></p>
                        </div>
                    </div>
                    <button id="logout-button" class="mt-3 w-full flex items-center justify-center rounded-2xl border border-gray-300 bg-gray-100 px-3 py-2.5 text-base font-medium text-gray-700 shadow-md hover:bg-gray-200 hover:border-red-500 hover:text-red-600">
                        <i data-lucide="log-out" class="w-4 h-4 mr-2 text-gray-500"></i>
                        Logout
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Content Area Wrapper -->
        <div id="main-content-wrapper" class="flex flex-1 flex-col pl-72 transition-[padding] duration-300 ease-in-out sm:pl-20 md:pl-72">
            <!-- Header -->
            <header class="sticky top-0 z-10 flex h-16 flex-shrink-0 border-b border-gray-200 bg-white/95 backdrop-blur-sm no-print">
                <div class="flex flex-1 items-center justify-between px-6 lg:px-8">

                    <!-- Mobile Sidebar Toggle / Page Title -->
                    <div class="flex items-center space-x-4">
                        <button id="sidebar-toggle-mobile" type="button" class="md:hidden p-2 rounded-full text-gray-600 hover:bg-gray-200" style="display: none;">
                            <i data-lucide="menu" class="h-6 w-6"></i>
                        </button>
                        <h1 id="page-title" class="text-2xl font-semibold text-gray-900">Dashboard</h1>
                         <!-- Live Sync Indicator -->
                        <div id="live-sync-indicator" class="flex items-center ml-4">
                            <span class="relative flex h-3 w-3 mr-2">
                                <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                                <span class="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span>
                            </span>
                            <span class="text-sm text-green-600 font-inter hidden sm:inline">Live Sync</span>
                        </div>
                    </div>

                    <div class="flex items-center space-x-4">

                        <!-- Notifications Icon -->
                        <button type="button" id="notifications-toggle" class="p-2 rounded-full text-gray-600 hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 relative">
                            <i data-lucide="bell" class="h-5 w-5"></i>
                            <!-- Notification Badge -->
                            <span id="notification-badge" class="absolute top-1 right-1 h-2 w-2 rounded-full bg-red-500 hidden"></span>
                        </button>

                        <!-- Main Action Button -->
                        <button type="button" id="main-add-button" class="hidden sm:flex items-center justify-center rounded-2xl border border-transparent bg-blue-600 px-4 py-2.5 text-base font-medium text-white shadow-lg hover:bg-blue-700 transition-all duration-200 hover:scale-[1.02] focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                            <!-- Button content will be set dynamically -->
                        </button>
                    </div>
                </div>
            </header>

            <!-- Main Page Content -->
            <main class="flex-1 overflow-y-auto">
                <div class="mx-auto max-w-7xl px-8 py-6 sm:px-8 lg:px-8 bg-gray-50 min-h-full">

                    <!-- NEW: Mobile Floating Add Button -->
                    <button id="mobile-float-add-button" class="fixed bottom-6 right-6 z-40 sm:hidden h-14 w-14 rounded-full bg-blue-600 text-white shadow-xl flex items-center justify-center transform transition-transform duration-300 hover:scale-105 active:scale-95 hidden">
                        <i data-lucide="plus" class="w-7 h-7"></i>
                    </button>

                    <!--
                    ================ PAGE: DASHBOARD ================
                    -->
                    <div id="page-dashboard" class="page-content active space-y-8">
                        <h2 class="text-3xl font-bold text-gray-900">Overview</h2>
                        <!-- Stat Cards (Adjusted grid and spacing for consistency) -->
                        <div class="grid grid-cols-1 gap-6 sm:grid-cols-2 xl:grid-cols-5">
                            <!-- Total Vendors -->
                            <div class="bg-white shadow-2xl border border-gray-100 overflow-hidden rounded-2xl hover-lift min-w-[240px]">
                                <div class="p-6">
                                    <div class="flex items-start">
                                        <div class="flex-shrink-0 rounded-xl bg-blue-100 p-3 shadow-md shadow-blue-50/50">
                                            <i data-lucide="users" class="h-6 w-6 text-blue-600"></i>
                                        </div>
                                        <div class="ml-4 w-0 flex-1">
                                            <dl>
                                                <dt class="truncate text-sm font-medium text-gray-600 font-inter">Total Vendors</dt>
                                                <dd class="text-4xl font-bold tracking-tight text-gray-900 mt-1" id="stat-total-vendors">0</dd>
                                            </dl>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Jobs This Month -->
                            <div class="bg-white shadow-2xl border border-gray-100 overflow-hidden rounded-2xl hover-lift min-w-[240px]">
                                <div class="p-6">
                                    <div class="flex items-start">
                                        <div class="flex-shrink-0 rounded-xl bg-green-100 p-3 shadow-md shadow-green-50/50">
                                            <i data-lucide="calendar-days" class="h-6 w-6 text-green-600"></i>
                                        </div>
                                        <div class="ml-4 w-0 flex-1">
                                            <dl>
                                                <dt class="truncate text-sm font-medium text-gray-600 font-inter">Jobs This Month</dt>
                                                <dd class="text-4xl font-bold tracking-tight text-gray-900 mt-1" id="stat-month-jobs">0</dd>
                                            </dl>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Pending Jobs -->
                            <div class="bg-white shadow-2xl border border-gray-100 overflow-hidden rounded-2xl hover-lift min-w-[240px]">
                                <div class="p-6">
                                    <div class="flex items-start">
                                        <div class="flex-shrink-0 rounded-xl bg-yellow-100 p-3 shadow-md shadow-yellow-50/50">
                                            <i data-lucide="clock" class="h-6 w-6 text-yellow-600"></i>
                                        </div>
                                        <div class="ml-4 w-0 flex-1">
                                            <dl>
                                                <dt class="truncate text-sm font-medium text-gray-600 font-inter">Pending Jobs</dt>
                                                <dd class="text-4xl font-bold tracking-tight text-gray-900 mt-1" id="stat-pending-jobs">0</dd>
                                            </dl>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Unbilled Jobs -->
                            <div class="bg-white shadow-2xl border border-gray-100 overflow-hidden rounded-2xl hover-lift min-w-[240px]">
                                <div class="p-6">
                                    <div class="flex items-start">
                                        <div class="flex-shrink-0 rounded-xl bg-red-100 p-3 shadow-md shadow-red-50/50">
                                            <i data-lucide="receipt" class="h-6 w-6 text-red-600"></i>
                                        </div>
                                        <div class="ml-4 w-0 flex-1">
                                            <dl>
                                                <dt class="truncate text-sm font-medium text-gray-600 font-inter">Pending Bills</dt>
                                                <dd class="text-4xl font-bold tracking-tight text-gray-900 mt-1" id="stat-unbilled-jobs">0</dd>
                                            </dl>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- NEW STAT: Total Net Output -->
                            <div class="bg-white shadow-2xl border border-gray-100 overflow-hidden rounded-2xl hover-lift min-w-[240px]">
                                <div class="p-6">
                                    <div class="flex items-start">
                                        <div class="flex-shrink-0 rounded-xl bg-purple-100 p-3 shadow-md shadow-purple-50/50">
                                            <i data-lucide="scale" class="h-6 w-6 text-purple-600"></i>
                                        </div>
                                        <div class="ml-4 w-0 flex-1">
                                            <dl>
                                                <dt class="truncate text-sm font-medium text-gray-600 font-inter">Total Net Output (g)</dt>
                                                <dd class="text-4xl font-bold tracking-tight text-gray-900 mt-1" id="stat-total-net-output">0</dd>
                                            </dl>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Chart (Step 2: Added .chart-container) -->
                        <div class="bg-white shadow-2xl border border-gray-100 rounded-2xl p-6">
                            <h3 class="text-xl font-semibold leading-relaxed text-gray-900">Recent Job Weights (Last 10)</h3>
                            <p class="text-sm text-gray-600 font-inter mb-4">Gross vs. Net weight comparison for recently completed jobs.</p>
                            <div class="chart-container overflow-x-auto">
                                <canvas id="melting-chart" class="mt-4 w-full h-[400px]"></canvas>
                            </div>
                        </div>
                    </div>

                    <!--
                    ================ PAGE: VENDOR MANAGEMENT ================
                    -->
                    <div id="page-vendors" class="page-content hidden">
                        <div class="bg-white shadow-2xl border border-gray-100 overflow-hidden rounded-2xl">
                            <div class="p-6 flex flex-col sm:flex-row justify-between items-center border-b border-gray-200 gap-4">
                                <label for="vendor-search" class="sr-only">Search vendors</label>
                                <input type="text" id="vendor-search" class="block w-full sm:w-1/3 rounded-2xl border-gray-300 bg-gray-50 text-gray-900 shadow-sm focus:border-blue-600 focus:ring-blue-600 placeholder-gray-500 px-4 py-3 font-inter" placeholder="Search by name or mobile...">
                                <button id="vendor-export-csv-button" data-type="vendor" class="inline-flex items-center rounded-2xl border border-gray-300 bg-white px-5 py-3 text-base font-medium text-gray-700 shadow-md hover:bg-gray-100 transition-all duration-200 hover:scale-[1.02]">
                                    <i data-lucide="file-text" class="w-4 h-4 mr-2"></i> Export CSV
                                </button>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead>
                                        <tr class="bg-gray-50">
                                            <th scope="col" class="px-6 py-4 text-left text-xs font-semibold uppercase tracking-wider text-gray-600 font-inter">Name</th>
                                            <th scope="col" class="px-6 py-4 text-left text-xs font-semibold uppercase tracking-wider text-gray-600 font-inter">Mobile</th>
                                            <th scope="col" class="px-6 py-4 text-left text-xs font-semibold uppercase tracking-wider text-gray-600 font-inter">Address</th>
                                            <th scope="col" class="px-6 py-4 text-left text-xs font-semibold uppercase tracking-wider text-gray-600 font-inter">Joined</th>
                                            <th scope="col" class="px-6 py-4 text-left text-xs font-semibold uppercase tracking-wider text-gray-600 font-inter">Last Job Date</th>
                                            <th scope="col" class="px-6 py-4 text-right text-xs font-semibold uppercase tracking-wider text-gray-600 font-inter">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="vendors-table-body" class="divide-y divide-gray-200">
                                        <!-- Rows will be injected by JS -->
                                    </tbody>
                                </table>
                            </div>
                            <div id="vendors-empty-state" class="hidden p-12 text-center">
                                <i data-lucide="users" class="mx-auto h-12 w-12 text-gray-400"></i>
                                <h3 class="mt-2 text-lg font-medium text-gray-900">No vendors found</h3>
                                <p class="mt-1 text-sm text-gray-600 font-inter">Get started by adding a new vendor.</p>
                            </div>
                        </div>
                    </div>

                    <!--
                    ================ PAGE: MELTING RECORDS ================
                    -->
                    <div id="page-melting-records" class="page-content hidden">
                         <div class="bg-white shadow-2xl border border-gray-100 overflow-hidden rounded-2xl">
                            <div class="p-6 flex flex-col sm:flex-row justify-between items-center border-b border-gray-200 gap-4">
                                <div class="w-full sm:w-1/3">
                                    <label for="purity-filter" class="sr-only">Purity Filter</label>
                                    <select id="purity-filter" class="block w-full rounded-2xl border-gray-300 bg-gray-50 text-gray-900 shadow-sm focus:border-blue-600 focus:ring-blue-600 sm:text-base px-4 py-3 font-inter">
                                        <option value="all">Filter by Purity...</option>
                                        <option value="high">Purity > 95%</option>
                                        <option value="medium">Purity 90% - 95%</option>
                                        <option value="low">Purity < 90%</option>
                                    </select>
                                </div>
                                <button id="jobs-export-csv-button" data-type="meltingJob" class="inline-flex items-center rounded-2xl border border-gray-300 bg-white px-5 py-3 text-base font-medium text-gray-700 shadow-md hover:bg-gray-100 transition-all duration-200 hover:scale-[1.02]">
                                    <i data-lucide="file-text" class="w-4 h-4 mr-2"></i> Export CSV
                                </button>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead>
                                        <tr class="bg-gray-50">
                                            <th class="px-6 py-4 text-left text-xs font-semibold uppercase tracking-wider text-gray-600 font-inter">Vendor</th>
                                            <th class="px-6 py-4 text-left text-xs font-semibold uppercase tracking-wider text-gray-600 font-inter">Date</th>
                                            <th class="px-6 py-4 text-left text-xs font-semibold uppercase tracking-wider text-gray-600 font-inter">Item Type</th>
                                            <th class="px-6 py-4 text-left text-xs font-semibold uppercase tracking-wider text-gray-600 font-inter">Gross (g)</th>
                                            <th class="px-6 py-4 text-left text-xs font-semibold uppercase tracking-wider text-gray-600 font-inter">Purity (%)</th>
                                            <th class="px-6 py-4 text-left text-xs font-semibold uppercase tracking-wider text-gray-600 font-inter">Net (g)</th>
                                            <th class="px-6 py-4 text-left text-xs font-semibold uppercase tracking-wider text-gray-600 font-inter">Status</th>
                                            <th class="px-6 py-4 text-right text-xs font-semibold uppercase tracking-wider text-gray-600 font-inter">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="melting-jobs-table-body" class="divide-y divide-gray-200">
                                        <!-- Rows will be injected by JS -->
                                    </tbody>
                                </table>
                            </div>
                            <div id="melting-jobs-empty-state" class="hidden p-12 text-center">
                                <i data-lucide="flame" class="mx-auto h-12 w-12 text-gray-400"></i>
                                <h3 class="mt-2 text-lg font-medium text-gray-900">No melting records found</h3>
                                <p class="mt-1 text-sm text-gray-600 font-inter">Get started by adding a new melting record.</p>
                            </div>
                        </div>
                    </div>

                    <!--
                    ================ NEW PAGE: INVENTORY TRACKING ================
                    -->
                    <div id="page-inventory" class="page-content hidden">
                        <!-- Summary Panel -->
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
                            <!-- Total Inventory Weight -->
                            <div class="bg-white shadow-2xl border border-gray-100 overflow-hidden rounded-2xl p-6 hover-lift">
                                <p class="text-sm font-medium text-gray-600 font-inter">Total Inventory Weight (g)</p>
                                <p id="inv-stat-total-weight" class="text-3xl font-bold text-gray-900 mt-1">0</p>
                            </div>
                            <!-- Total Items -->
                            <div class="bg-white shadow-2xl border border-gray-100 overflow-hidden rounded-2xl p-6 hover-lift">
                                <p class="text-sm font-medium text-gray-600 font-inter">Total Items in Stock</p>
                                <p id="inv-stat-total-items" class="text-3xl font-bold text-gray-900 mt-1">0</p>
                            </div>
                            <!-- Low Stock Items -->
                            <div class="bg-white shadow-2xl border border-gray-100 overflow-hidden rounded-2xl p-6 hover-lift">
                                <p class="text-sm font-medium text-gray-600 font-inter">Low Stock Items</p>
                                <p id="inv-stat-low-stock" class="text-3xl font-bold text-red-600 mt-1">0</p>
                            </div>
                        </div>

                        <!-- Inventory Table -->
                        <div class="bg-white shadow-2xl border border-gray-100 overflow-hidden rounded-2xl">
                            <div class="p-6 flex flex-col sm:flex-row justify-between items-center border-b border-gray-200 gap-4">
                                <label for="inventory-search" class="sr-only">Search inventory</label>
                                <input type="text" id="inventory-search" class="block w-full sm:w-1/3 rounded-2xl border-gray-300 bg-gray-50 text-gray-900 shadow-sm focus:border-blue-600 focus:ring-blue-600 placeholder-gray-500 px-4 py-2.5 font-inter">
                            </div>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead>
                                        <tr class="bg-gray-50">
                                            <th scope="col" class="px-6 py-4 text-left text-xs font-semibold uppercase tracking-wider text-gray-600 font-inter">Item Type</th>
                                            <th scope="col" class="px-6 py-4 text-left text-xs font-semibold uppercase tracking-wider text-gray-600 font-inter">Weight (g)</th>
                                            <th scope="col" class="px-6 py-4 text-left text-xs font-semibold uppercase tracking-wider text-gray-600 font-inter">Purity (%)</th>
                                            <th scope="col" class="px-6 py-4 text-left text-xs font-semibold uppercase tracking-wider text-gray-600 font-inter">Quantity</th>
                                            <th scope="col" class="px-6 py-4 text-right text-xs font-semibold uppercase tracking-wider text-gray-600 font-inter">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="inventory-table-body" class="divide-y divide-gray-200">
                                        <!-- Rows will be injected by JS -->
                                    </tbody>
                                </table>
                            </div>
                            <div id="inventory-empty-state" class="hidden p-12 text-center">
                                <i data-lucide="package-open" class="mx-auto h-12 w-12 text-gray-400"></i>
                                <h3 class="mt-2 text-lg font-medium text-gray-900">No inventory items found</h3>
                                <p class="mt-1 text-sm text-gray-600 font-inter">Add stock items to track your inventory.</p>
                            </div>
                        </div>
                    </div>

                    <!--
                    ================ NEW PAGE: PURCHASE ORDERS ================
                    -->
                    <div id="page-purchase-orders" class="page-content hidden">
                         <!-- Summary Panel -->
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
                            <!-- Total Orders -->
                            <div class="bg-white shadow-2xl border border-gray-100 overflow-hidden rounded-2xl p-6 hover-lift">
                                <p class="text-sm font-medium text-gray-600 font-inter">Total Orders</p>
                                <p id="po-stat-total-orders" class="text-3xl font-bold text-gray-900 mt-1">0</p>
                            </div>
                            <!-- Pending Orders -->
                            <div class="bg-white shadow-2xl border border-gray-100 overflow-hidden rounded-2xl p-6 hover-lift">
                                <p class="text-sm font-medium text-gray-600 font-inter">Pending Payment</p>
                                <p id="po-stat-pending-orders" class="text-3xl font-bold text-yellow-600 mt-1">0</p>
                            </div>
                            <!-- Total Weight Ordered -->
                            <div class="bg-white shadow-2xl border border-gray-100 overflow-hidden rounded-2xl p-6 hover-lift">
                                <p class="text-sm font-medium text-gray-600 font-inter">Total Weight Ordered (g)</p>
                                <p id="po-stat-total-weight" class="text-3xl font-bold text-gray-900 mt-1">0</p>
                            </div>
                        </div>

                        <!-- PO Table -->
                         <div class="bg-white shadow-2xl border border-gray-100 overflow-hidden rounded-2xl">
                            <div class="p-6 flex flex-col sm:flex-row justify-between items-center border-b border-gray-200 gap-4">
                                <label for="po-search" class="sr-only">Search orders</label>
                                <input type="text" id="po-search" class="block w-full sm:w-1/3 rounded-2xl border-gray-300 bg-gray-50 text-gray-900 shadow-sm focus:border-blue-600 focus:ring-blue-600 placeholder-gray-500 px-4 py-2.5 font-inter">
                            </div>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead>
                                        <tr class="bg-gray-50">
                                            <th scope="col" class="px-6 py-4 text-left text-xs font-semibold uppercase tracking-wider text-gray-600 font-inter">Supplier</th>
                                            <th scope="col" class="px-6 py-4 text-left text-xs font-semibold uppercase tracking-wider text-gray-600 font-inter">Date</th>
                                            <th scope="col" class="px-6 py-4 text-left text-xs font-semibold uppercase tracking-wider text-gray-600 font-inter">Weight (g)</th>
                                            <th scope="col" class="px-6 py-4 text-left text-xs font-semibold uppercase tracking-wider text-gray-600 font-inter">Total Amount (â‚¹)</th>
                                            <th scope="col" class="px-6 py-4 text-left text-xs font-semibold uppercase tracking-wider text-gray-600 font-inter">Status</th>
                                            <th scope="col" class="px-6 py-4 text-right text-xs font-semibold uppercase tracking-wider text-gray-600 font-inter">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="purchase-orders-table-body" class="divide-y divide-gray-200">
                                        <!-- Rows will be injected by JS -->
                                    </tbody>
                                </table>
                            </div>
                            <div id="purchase-orders-empty-state" class="hidden p-12 text-center">
                                <i data-lucide="shopping-cart" class="mx-auto h-12 w-12 text-gray-400"></i>
                                <h3 class="mt-2 text-lg font-medium text-gray-900">No purchase orders found</h3>
                                <p class="mt-1 text-sm text-gray-600 font-inter">Add new raw material purchase orders.</p>
                            </div>
                        </div>
                    </div>

                    <!--
                    ================ PAGE: BILLING SYSTEM ================
                    -->
                    <div id="page-billing" class="page-content hidden">
                        <div class="bg-white shadow-2xl border border-gray-100 rounded-2xl p-6">
                            <h3 class="text-xl font-semibold text-gray-900">Generate Customer Bill</h3>
                            <div class="mt-4 max-w-md">
                                <label for="billing-vendor-select" class="block text-sm font-medium text-gray-700">Select Vendor</label>
                                <select id="billing-vendor-select" class="mt-1 block w-full rounded-2xl border-gray-300 bg-white py-3 pl-3 pr-10 text-gray-900 focus:border-blue-600 focus:outline-none focus:ring-blue-600 sm:text-sm font-inter">
                                    <option value="">Select a vendor...</option>
                                    <!-- Options injected by JS -->
                                </select>
                            </div>
                        </div>

                        <div id="billing-jobs-section" class="hidden bg-white shadow-2xl border border-gray-100 overflow-hidden rounded-2xl">
                            <div class="p-6 border-b border-gray-200">
                                <h3 class="text-xl font-semibold text-gray-900" id="billing-vendor-name">Unbilled Jobs for...</h3>
                            </div>

                            <!-- NEW: Quick Bill Summary -->
                            <div class="p-6 grid grid-cols-2 gap-4 bg-gray-50">
                                <div>
                                    <p class="text-sm font-medium text-gray-600 font-inter">Selected Gross Weight</p>
                                    <p id="bill-summary-gross" class="text-2xl font-bold text-gray-900">0.00 g</p>
                                </div>
                                <div>
                                    <p class="text-sm font-medium text-gray-600 font-inter">Selected Net Weight</p>
                                    <p id="bill-summary-net" class="text-2xl font-bold text-gray-900">0.00 g</p>
                                </div>
                            </div>

                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead>
                                        <tr class="bg-gray-50">
                                            <th class="py-3.5 pl-4 pr-3 text-left text-sm font-semibold text-gray-900">
                                                <input type="checkbox" id="bill-select-all" class="h-5 w-5 rounded-md border-gray-400 bg-gray-100 text-blue-600 focus:ring-blue-600 focus:ring-offset-white">
                                            </th>
                                            <th class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider text-gray-600 font-inter">Date</th>
                                            <th class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider text-gray-600 font-inter">Item</th>
                                            <th class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider text-gray-600 font-inter">Gross (g)</th>
                                            <th class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider text-gray-600 font-inter">Net (g)</th>
                                            <th class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider text-gray-600 font-inter">Charge</th>
                                        </tr>
                                    </thead>
                                    <tbody id="billing-table-body" class="divide-y divide-gray-200">
                                        <!-- Rows will be injected by JS -->
                                    </tbody>
                                </table>
                            </div>
                             <div id="billing-empty-state" class="hidden p-12 text-center">
                                <i data-lucide="info" class="mx-auto h-12 w-12 text-gray-400"></i>
                                <h3 class="mt-2 text-lg font-medium text-gray-900">No unbilled jobs for this vendor.</h3>
                            </div>
                            <div class="flex items-center justify-between bg-gray-50 p-6">
                                <div class="text-base font-medium text-gray-700">
                                    Total Selected Charge: <span id="billing-total-charge" class="text-2xl font-bold text-blue-600">â‚¹0.00</span>
                                </div>
                                <button id="generate-bill-button" class="rounded-2xl border border-transparent bg-blue-600 px-4 py-3 text-base font-medium text-white shadow-md hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200 hover:scale-[1.02]" disabled>
                                    Generate Bill
                                </button>
                            </div>
                        </div>
                    </div>

                    <!--
                    ================ PAGE: REPORTS & ANALYTICS ================
                    -->
                    <div id="page-reports" class="page-content hidden">
                        <!-- Gradient Header for Reports -->
                        <div class="rounded-2xl p-6 bg-gradient-to-r from-blue-600 to-indigo-500 shadow-2xl">
                             <h2 class="text-3xl font-bold text-white mb-1">Performance Analytics</h2>
                             <p class="text-base text-blue-100 font-inter">Visualize melting trends, purity metrics, and monthly revenue performance.</p>
                        </div>

                        <!-- FIX: Scrollable container for charts -->
                        <div class="max-h-[calc(100vh-250px)] overflow-y-auto space-y-8 pr-2">
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <!-- Monthly Melting Trend Chart -->
                                <div class="bg-white shadow-2xl border border-gray-100 rounded-2xl p-6 hover-lift">
                                    <h3 class="text-xl font-semibold text-gray-900">Monthly Melting Trend (Net Output)</h3>
                                    <p class="text-sm text-gray-600 font-inter mb-4">Total net silver output in grams per month.</p>
                                    <div class="h-[450px] min-h-[400px] chart-container overflow-x-auto"><canvas id="reports-monthly-melting"></canvas></div>
                                </div>

                                <!-- Purity Distribution Chart -->
                                <div class="bg-white shadow-2xl border border-gray-100 rounded-2xl p-6 hover-lift">
                                    <h3 class="text-xl font-semibold text-gray-900">Job Purity Distribution</h3>
                                    <p class="text-sm text-gray-600 font-inter mb-4">Breakdown of completed jobs by purity level.</p>
                                    <div class="h-[450px] min-h-[400px] flex items-center justify-center chart-container overflow-x-auto"><canvas id="reports-purity-distribution"></canvas></div>
                                </div>

                                <!-- Monthly Revenue Chart -->
                                <div class="lg:col-span-2 bg-white shadow-2xl border border-gray-100 rounded-2xl p-6 hover-lift">
                                    <h3 class="text-xl font-semibold text-gray-900">Monthly Revenue Trend</h3>
                                    <p class="text-sm text-gray-600 font-inter mb-4">Total melting charges billed per month.</p>
                                    <div class="h-[450px] min-h-[400px] chart-container overflow-x-auto"><canvas id="reports-monthly-revenue"></canvas></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!--
                    ================ NEW PAGE: USER MANAGEMENT (Simulated) ================
                    -->
                    <div id="page-user-mgmt" class="page-content hidden">
                        <div class="bg-white shadow-2xl border border-gray-100 overflow-hidden rounded-2xl">
                            <div class="p-6 border-b border-gray-200">
                                <h3 class="text-xl font-semibold text-gray-900">System Users (Simulated)</h3>
                                <p class="text-sm text-gray-600 font-inter mt-1">Manage user roles and permissions within the application.</p>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead>
                                        <tr class="bg-gray-50">
                                            <th scope="col" class="px-6 py-4 text-left text-xs font-semibold uppercase tracking-wider text-gray-600 font-inter">Name</th>
                                            <th scope="col" class="px-6 py-4 text-left text-xs font-semibold uppercase tracking-wider text-gray-600 font-inter">User ID (First 8)</th>
                                            <th scope="col" class="px-6 py-4 text-left text-xs font-semibold uppercase tracking-wider text-gray-600 font-inter">Status</th>
                                            <th scope="col" class="px-6 py-4 text-left text-xs font-semibold uppercase tracking-wider text-gray-600 font-inter">Role</th>
                                            <th scope="col" class="px-6 py-4 text-right text-xs font-semibold uppercase tracking-wider text-gray-600 font-inter">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="user-mgmt-table-body" class="divide-y divide-gray-200">
                                        <!-- Rows will be injected by JS -->
                                    </tbody>
                                </table>
                            </div>
                            <div id="user-mgmt-empty-state" class="hidden p-12 text-center">
                                <i data-lucide="shield-check" class="mx-auto h-12 w-12 text-gray-400"></i>
                                <h3 class="mt-2 text-lg font-medium text-gray-900">No users found.</h3>
                                <p class="mt-1 text-sm text-gray-600 font-inter">Only the current user is listed by default.</p>
                            </div>
                        </div>
                    </div>

                    <!--
                    ================ NEW PAGE: NOTIFICATIONS ================
                    -->
                    <div id="page-notifications" class="page-content hidden">
                        <div class="bg-white shadow-2xl border border-gray-100 overflow-hidden rounded-2xl">
                            <div class="p-6 border-b border-gray-200">
                                <h3 class="text-xl font-semibold text-gray-900">Real-time Business Alerts</h3>
                                <p class="text-sm text-gray-600 font-inter mt-1">System-generated notifications requiring immediate attention.</p>
                            </div>
                            <div id="notifications-list" class="divide-y divide-gray-200">
                                <!-- Notifications injected here -->
                                <div id="notifications-empty-state" class="p-12 text-center">
                                    <i data-lucide="check-circle" class="mx-auto h-12 w-12 text-green-500"></i>
                                    <h3 class="mt-2 text-lg font-medium text-gray-900">All Clear!</h3>
                                    <p class="mt-1 text-sm text-gray-600 font-inter">No pressing issues found in the system.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!--
                    ================ PAGE: MY PROFILE ================
                    -->
                    <div id="page-profile" class="page-content hidden">
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                            <!-- Column 1: Profile Card -->
                            <div class="lg:col-span-1 space-y-6">
                                <div class="bg-white shadow-2xl border border-gray-100 overflow-hidden rounded-2xl hover-lift">
                                    <div class="p-6 flex flex-col items-center">
                                        <img id="profile-avatar-img" class="h-24 w-24 rounded-full" src="https://placehold.co/96x96/2563eb/ffffff?text=A" alt="User Avatar">
                                        <h3 class="mt-4 text-2xl font-bold text-gray-900" id="profile-name-display">Administrator</h3>
                                        <p class="mt-1 text-base text-gray-600 font-inter" id="profile-email-display">admin@example.com</p>
                                    </div>
                                    <div class="border-t border-gray-200 px-6 py-4 space-y-2 font-inter">
                                        <div class="flex justify-between text-sm">
                                            <span class="font-medium text-gray-600">Joined:</span>
                                            <span class="font-medium text-gray-900" id="profile-joined-display">...</span>
                                        </div>
                                        <div class="flex justify-between text-sm">
                                            <span class="font-medium text-gray-600">User ID:</span>
                                            <span class="font-medium text-gray-900" id="profile-user-id-display">...</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="bg-white shadow-2xl border border-gray-100 overflow-hidden rounded-2xl hover-lift">
                                    <div class="p-6 border-b border-gray-200">
                                        <h3 class="text-xl font-semibold text-gray-900">Your Activity Stats</h3>
                                    </div>
                                    <div class="p-6 space-y-4">
                                        <div class="flex items-center">
                                            <div class="flex-shrink-0 rounded-xl bg-blue-100 p-3 shadow-md shadow-blue-50/50">
                                                <i data-lucide="users" class="h-6 w-6 text-blue-600"></i>
                                            </div>
                                            <div class="ml-4">
                                                <p class="text-3xl font-bold text-gray-900" id="profile-stat-vendors">0</p>
                                                <p class="text-sm font-medium text-gray-600 font-inter">Total Vendors</p>
                                            </div>
                                        </div>
                                        <div class="flex items-center">
                                            <div class="flex-shrink-0 rounded-xl bg-green-100 p-3 shadow-md shadow-green-50/50">
                                                <i data-lucide="flame" class="h-6 w-6 text-green-600"></i>
                                            </div>
                                            <div class="ml-4">
                                                <p class="text-3xl font-bold text-gray-900" id="profile-stat-jobs">0</p>
                                                <p class="text-sm font-medium text-gray-600 font-inter">Total Melting Jobs</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Column 2: Settings -->
                            <div class="lg:col-span-2 space-y-6">
                                <div class="bg-white shadow-2xl border border-gray-100 overflow-hidden rounded-2xl">
                                    <div class="p-6 border-b border-gray-200">
                                        <h3 class="text-xl font-semibold text-gray-900">Profile Settings</h3>
                                    </div>
                                    <form id="profile-name-form" class="p-6 space-y-6">
                                        <div>
                                            <label for="profile-name-input" class="block text-sm font-medium text-gray-700">Display Name</label>
                                            <input type="text" id="profile-name-input" name="displayName" class="mt-1 block w-full max-w-xs rounded-2xl border-gray-300 bg-gray-50 text-gray-900 shadow-sm sm:text-base px-4 py-3 focus:border-blue-600 focus:ring-blue-600 font-inter">
                                        </div>
                                        <div>
                                            <button type="submit" class="inline-flex items-center rounded-2xl border border-transparent bg-blue-600 px-5 py-3 text-base font-medium text-white shadow-md hover:bg-blue-700 transition-all duration-200 hover:scale-[1.02]">
                                                <i data-lucide="save" class="w-4 h-4 mr-2"></i>
                                                Save Name
                                            </button>
                                        </div>
                                    </form>
                                </div>

                                <div class="bg-white shadow-2xl border border-gray-100 overflow-hidden rounded-2xl">
                                    <div class="p-6 border-b border-gray-200">
                                        <h3 class="text-xl font-semibold text-gray-900">Security</h3>
                                    </div>
                                    <div class="p-6 space-y-6">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Password</label>
                                            <p class="mt-1 text-sm text-gray-600 font-inter">To change your password, we'll send a reset link to your email address.</p>
                                        </div>
                                        <div>
                                            <button type="button" id="profile-change-password-button" class="inline-flex items-center rounded-2xl border border-gray-300 bg-white px-5 py-3 text-base font-medium text-gray-700 shadow-md hover:bg-gray-100 transition-all duration-200 hover:scale-[1.02]">
                                                <i data-lucide="key-round" class="w-4 h-4 mr-2"></i>
                                                Send Password Reset Email
                                            </button>
                                        </div>
                                        <div id="password-reset-success" class="hidden text-sm text-green-600 font-inter"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>


                    <!--
                    ================ PAGE: SETTINGS ================
                    -->
                    <div id="page-settings" class="page-content hidden">
                        <div class="bg-white shadow-2xl border border-gray-100 overflow-hidden rounded-2xl">
                            <div class="p-6 border-b border-gray-200">
                                <h3 class="text-xl font-semibold text-gray-900">Application Settings</h3>
                            </div>
                            <form id="settings-form" class="p-6 space-y-6">
                                <div>
                                    <label for="setting-melting-charge" class="block text-sm font-medium text-gray-700">Melting Charge per KG (â‚¹)</label>
                                    <input type="number" step="0.01" id="setting-melting-charge" name="meltingChargePerKg" class="mt-1 block w-full max-w-xs rounded-2xl border-gray-300 bg-gray-50 text-gray-900 shadow-sm sm:text-base px-4 py-3 focus:border-blue-600 focus:ring-blue-600 font-inter">
                                    <p class="mt-2 text-xs text-gray-600 font-inter">This charge will be used for all new billing calculations.</p>
                                </div>
                                <!-- NEW SETTING: Low Stock Threshold -->
                                <div>
                                    <label for="setting-low-stock-threshold" class="block text-sm font-medium text-gray-700">Low Inventory Threshold (Quantity)</label>
                                    <input type="number" step="1" id="setting-low-stock-threshold" name="lowStockThreshold" class="mt-1 block w-full max-w-xs rounded-2xl border-gray-300 bg-gray-50 text-gray-900 shadow-sm sm:text-base px-4 py-3 focus:border-blue-600 focus:ring-blue-600 font-inter">
                                    <p class="mt-2 text-xs text-gray-600 font-inter">Triggers a notification when inventory quantity falls below this number.</p>
                                </div>
                                <div>
                                    <button type="submit" id="save-settings-button" class="inline-flex items-center rounded-2xl border border-transparent bg-blue-600 px-5 py-3 text-base font-medium text-white shadow-md hover:bg-blue-700 transition-all duration-200 hover:scale-[1.02]">
                                        <i data-lucide="save" class="w-4 h-4 mr-2"></i>
                                        Save Settings
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                </div>
            </main>
        </div>

        <!-- Mobile Sidebar Overlay -->
        <div id="mobile-sidebar-overlay" class="fixed inset-0 bg-black/50 z-40 hidden md:hidden"></div>
    </div>


    <!--
    ============================================================
    MODALS
    ============================================================
    -->

    <!-- Generic Form Modal -->
    <div id="form-modal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black/60 opacity-0 transition-opacity duration-300 ease-in-out pointer-events-none no-print">
        <div class="modal-content max-h-[90vh] w-full max-w-xl transform rounded-2xl bg-white shadow-2xl transition-all border border-gray-200">
            <div class="flex items-center justify-between border-b border-gray-200 p-6">
                <h3 class="text-xl font-semibold text-gray-900" id="modal-title">Modal Title</h3>
                <button id="modal-close-button" class="text-gray-500 hover:text-gray-800 p-1">
                    <i data-lucide="x" class="h-6 w-6"></i>
                </button>
            </div>
            <form id="modal-form" class="overflow-y-auto max-h-[calc(90vh-140px)] p-6">
                <!-- Form content will be injected by JS -->
            </form>
            <div class="flex justify-end space-x-3 border-t border-gray-200 bg-gray-50 p-6 rounded-b-2xl">
                <button id="modal-cancel-button" type="button" class="rounded-2xl border border-gray-300 bg-white px-5 py-3 text-base font-medium text-gray-700 shadow-md hover:bg-gray-100">Cancel</button>
                <button id="modal-save-button" type="submit" form="modal-form" class="rounded-2xl border border-transparent bg-blue-600 px-5 py-3 text-base font-medium text-white shadow-md hover:bg-blue-700 transition-all duration-200 hover:scale-[1.02]">Save</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black/60 opacity-0 transition-opacity duration-300 ease-in-out pointer-events-none no-print">
        <div class="modal-content w-full max-w-md transform rounded-2xl bg-white shadow-2xl transition-all border border-gray-200">
            <div class="p-8 text-center">
                <i data-lucide="alert-triangle" class="mx-auto h-12 w-12 text-red-500"></i>
                <h3 class="mt-4 text-xl font-semibold text-gray-900">Delete Record?</h3>
                <p class="mt-2 text-base text-gray-600 font-inter">Are you sure you want to delete this record? This action cannot be undone.</p>
                <div class="mt-6 flex justify-center space-x-4">
                    <button id="delete-cancel-button" class="rounded-2xl border border-gray-300 bg-white px-5 py-3 text-base font-medium text-gray-700 shadow-md hover:bg-gray-100">Cancel</button>
                    <button id="delete-confirm-button" class="rounded-2xl border border-transparent bg-red-600 px-5 py-3 text-base font-medium text-white shadow-md hover:bg-red-700">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bill Modal (Bill content container ID set to bill-print-area for PDF) -->
    <div id="bill-modal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black/60 opacity-0 transition-opacity duration-300 ease-in-out pointer-events-none no-print">
        <div class="modal-content max-h-[90vh] w-full max-w-3xl transform rounded-2xl bg-white shadow-2xl transition-all border border-gray-200">
            <div class="flex items-center justify-between border-b border-gray-200 p-6 no-print">
                <h3 class="text-xl font-semibold text-gray-900" id="bill-modal-title">Generated Bill</h3>
                <button id="bill-modal-close-button" class="text-gray-500 hover:text-gray-800 p-1">
                    <i data-lucide="x" class="h-6 w-6"></i>
                </button>
            </div>

            <!-- Printable Area (Container for PDF Export) -->
            <div id="bill-print-area" class="overflow-y-auto max-h-[calc(90vh-140px)] p-8 bg-white text-black font-inter relative">
                <style>
                    /* Scoped styles just for printing, to ensure no dark-mode overrides */
                    #bill-print-area, #bill-print-area * {
                        background-color: #ffffff !important;
                        color: #000000 !important;
                        font-family: 'Inter', sans-serif !important;
                    }
                    /* Ensure watermark is visible and positioned correctly */
                    #bill-print-area::before {
                        content: "SATYAM REFINERY";
                        position: absolute;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%) rotate(-45deg);
                        font-size: 4rem;
                        font-weight: 700;
                        color: rgba(37, 99, 235, 0.08); /* Faint blue opacity */
                        pointer-events: none;
                        z-index: 0;
                    }
                </style>
                <div class="relative z-10"> <!-- Content wrapper to sit above watermark -->
                    <div class="flex justify-between items-center border-b pb-4 border-gray-300">
                        <div>
                            <div class="flex items-center space-x-2">
                                <!-- UPDATED LOGO: flame icon with blue color for print -->
                                <i data-lucide="flame" class="h-10 w-10" style="color: #2563eb !important; stroke: #2563eb !important;"></i>
                                <span class="text-3xl font-bold text-gray-900 font-poppins">Satyam Refinery</span>
                            </div>
                            <p class="text-sm text-gray-600">Owner: Sanjay Bhai Maratha</p>
                            <p class="text-sm text-gray-600">Santkabir Road, Jalganga Choke, Rajkot, Gujarat</p>
                            <p class="text-sm text-gray-600">Mobile: 9426979892</p>
                        </div>
                        <div class="text-right">
                            <h3 class="text-2xl font-semibold text-gray-800">MELTING BILL</h3>
                            <p class="text-sm text-gray-600">Bill ID: <span id="bill-id"></span></p>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mt-6">
                        <div>
                            <h4 class="text-sm font-semibold text-gray-500 uppercase tracking-wider">Bill To:</h4>
                            <p class="text-lg font-medium text-gray-900" id="bill-vendor-name-display"></p>
                            <p class="text-gray-600" id="bill-vendor-phone"></p>
                            <p class="text-gray-600" id="bill-vendor-address"></p>
                        </div>
                        <div class="text-right">
                            <p class="text-gray-600">Bill Date: <span class="font-medium text-gray-900" id="bill-date"></span></p>
                        </div>
                    </div>
                    <div class="mt-8 flow-root">
                        <div class="-my-2 overflow-x-auto">
                            <div class="inline-block min-w-full py-2 align-middle">
                                <table class="min-w-full divide-y divide-gray-300">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Date</th>
                                            <th class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Item Type</th>
                                            <th class="px-3 py-3.5 text-right text-sm font-semibold text-gray-900">Gross (g)</th>
                                            <th class="px-3 py-3.5 text-right text-sm font-semibold text-gray-900">Net (g)</th>
                                            <th class="px-3 py-3.5 text-right text-sm font-semibold text-gray-900">Charge (â‚¹)</th>
                                        </tr>
                                    </thead>
                                    <tbody id="bill-items-table" class="divide-y divide-gray-200 bg-white">
                                        <!-- Bill items injected by JS -->
                                    </tbody>
                                    <tfoot>
                                        <tr>
                                            <th colspan="2" scope="row" class="pt-4 pr-3 text-left text-base font-semibold text-gray-900">Total Gross Weight</th>
                                            <td class="pt-4 pl-3 pr-3 text-right text-base font-semibold text-gray-900" id="bill-total-gross">0.00 g</td>
                                            <th scope="row" class="pt-4 pr-3 text-right text-base font-semibold text-gray-900">Total Net</th>
                                            <td class="pt-4 pl-3 pr-3 text-right text-base font-semibold text-gray-900" id="bill-total-net">0.00 g</td>
                                        </tr>
                                        <tr>
                                            <th colspan="4" scope="row" class="py-1 pr-3 text-right text-base font-medium text-gray-600">Melting Charge</th>
                                            <td class="py-1 pl-3 pr-3 text-right text-base font-medium text-gray-600" id="bill-melting-charge">â‚¹0.00</td>
                                        </tr>
                                        <tr>
                                            <th colspan="4" scope="row" class="py-2 pr-3 text-right text-2xl font-bold text-gray-900">Total Amount Due</th>
                                            <td class="py-2 pl-3 pr-3 text-right text-2xl font-bold text-gray-900" id="bill-total-charge-display">â‚¹0.00</td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="mt-8 pt-8 border-t border-dashed border-gray-300">
                        <p class="text-center text-base text-gray-600">Thank you for your business!</p>
                        <p class="text-center text-sm text-gray-500">Computer Generated Bill</p>
                    </div>
                </div>
            </div>

            <div class="flex justify-end space-x-3 border-t border-gray-200 bg-gray-50 p-6 rounded-b-2xl no-print">
                <button id="bill-print-browser-button" type="button" class="inline-flex items-center rounded-2xl border border-gray-300 bg-white px-5 py-3 text-base font-medium text-gray-700 shadow-md hover:bg-gray-100 transition-all duration-200 hover:scale-[1.02]">
                    <i data-lucide="printer" class="w-5 h-5 mr-2"></i>
                    Print Bill
                </button>
                <button id="bill-pdf-button" type="button" class="inline-flex items-center rounded-2xl border border-transparent bg-blue-600 px-5 py-3 text-base font-medium text-white shadow-lg hover:bg-blue-700 transition-all duration-200 hover:scale-[1.02]">
                    <i data-lucide="download" class="w-5 h-5 mr-2"></i>
                    Download PDF
                </button>
            </div>
        </div>
    </div>


    <!--
    ============================================================
    ============================================================
    APPLICATION JAVASCRIPT
    ============================================================
    ============================================================
    -->

    <!-- Firebase SDK Imports -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth,
            onAuthStateChanged,
            signOut,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            updateProfile,
            sendPasswordResetEmail,
            signInWithCustomToken,
            signInAnonymously
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore,
            doc,
            getDoc,
            addDoc,
            setDoc,
            updateDoc,
            deleteDoc,
            onSnapshot,
            collection,
            query,
            where,
            getDocs,
            writeBatch,
            setLogLevel,
            serverTimestamp
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";

    document.addEventListener('DOMContentLoaded', () => {

        // ==========================================================
        // DATABASE & CONSTANTS
        // ==========================================================

        // This is a direct reference to the html2pdf library's main entry point, as requested
        const { html2pdf } = window;
        if (!html2pdf) {
            console.error("html2pdf.js not loaded!");
        }

        let CHARTS = {
            melting: null,
            reportsMonthlyMelting: null,
            reportsPurityDistribution: null,
            reportsMonthlyRevenue: null,
        };

        // Firebase instances
        let app, auth, db;

        // Application State
        let state = {
            currentPage: 'dashboard',
            deleteHandler: null,
            isAuthReady: false,
            userId: null,
            appId: typeof __app_id !== 'undefined' ? __app_id : 'default-app-id',

            // Core Data
            vendors: [],
            meltingJobs: [],
            inventory: [], // NEW
            purchaseOrders: [], // NEW
            appUsers: [], // NEW (Simulated user list)

            // Config & Settings
            settings: { meltingChargePerKg: 15.00, lowStockThreshold: 10 },

            // Listeners
            unsubVendors: null,
            unsubJobs: null,
            unsubInventory: null, // NEW
            unsubPurchaseOrders: null, // NEW
            unsubAppUsers: null, // NEW
            unsubSettings: null,
        };

        // ==========================================================
        // FIRESTORE API SERVICE
        // ==========================================================
        const ApiService = {

            // --- Collection References ---
            _getVendorsColRef: () => {
                if (!state.userId || !state.appId || !db) return null;
                return collection(db, `artifacts/${state.appId}/users/${state.userId}/vendors`);
            },
            _getJobsColRef: () => {
                if (!state.userId || !state.appId || !db) return null;
                return collection(db, `artifacts/${state.appId}/users/${state.userId}/meltingJobs`);
            },
            _getSettingsDocRef: () => {
                if (!state.userId || !state.appId || !db) return null;
                return doc(db, `artifacts/${state.appId}/users/${state.userId}/settings`, 'main');
            },
            _getInventoryColRef: () => { // NEW
                if (!state.userId || !state.appId || !db) return null;
                return collection(db, `artifacts/${state.appId}/users/${state.userId}/inventory`);
            },
            _getPurchaseOrdersColRef: () => { // NEW
                if (!state.userId || !state.appId || !db) return null;
                return collection(db, `artifacts/${state.appId}/users/${state.userId}/purchaseOrders`);
            },
            _getUsersColRef: () => { // NEW (Path corrected for permissions)
                if (!state.userId || !state.appId || !db) return null;
                return collection(db, `artifacts/${state.appId}/users/${state.userId}/appUsers`);
            },

            // --- Utils ---
            _formatGrams: (g) => g ? `${g.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })} g` : 'N/A',
            _formatPercent: (p) => p ? `${p.toFixed(2)} %` : 'N/A',
            _formatCurrency: (n) => n ? `â‚¹${n.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}` : 'N/A',
            _getJobCalculations: (job) => {
                let charge = 0;
                // Calculate charge based on Gross Weight and Kg rate
                charge = job.grossWeight * (state.settings.meltingChargePerKg / 1000);
                return { ...job, charge };
            },
            _getToday: () => new Date().toISOString().split('T')[0],

            // --- Dashboard ---
            getDashboardStats: () => {
                const jobs = state.meltingJobs.map(ApiService._getJobCalculations);
                const totalVendors = state.vendors.length;
                const thisMonth = new Date().getMonth();
                const monthJobs = jobs.filter(j => new Date(j.date).getMonth() === thisMonth).length;
                const pendingJobs = jobs.filter(j => j.status === 'Pending').length;
                const unbilledJobs = jobs.filter(j => j.status === 'Completed' && !j.billed).length;
                // NEW STAT: Total Net Output
                const totalNetOutput = jobs
                    .filter(j => j.status === 'Completed')
                    .reduce((sum, j) => sum + (j.outputWeight || 0), 0);

                return { totalVendors, monthJobs, pendingJobs, unbilledJobs, totalNetOutput };
            },
            getDashboardChart: () => {
                const last10Jobs = state.meltingJobs
                    .sort((a, b) => new Date(b.date) - new Date(a.date))
                    .slice(0, 10)
                    .reverse();
                return {
                    labels: last10Jobs.map((j, i) => `Job ${i + 1} (${j.date.slice(5)})`),
                    grossData: last10Jobs.map(j => j.grossWeight),
                    netData: last10Jobs.map(j => j.outputWeight || 0),
                };
            },

            // --- CSV Export Helper ---
            getExportData: (type) => {
                let data = [];
                let headers = [];
                switch(type) {
                    case 'vendor':
                        data = state.vendors.map(v => ({ Name: v.name, Mobile: v.mobile, Address: v.address, Joined: v.joined }));
                        headers = ['Name', 'Mobile', 'Address', 'Joined'];
                        break;
                    case 'meltingJob':
                        data = state.meltingJobs.map(j => {
                            const jobWithCalcs = ApiService._getJobCalculations(j);
                            return {
                                Vendor: j.vendorName || 'Unknown',
                                Date: j.date,
                                ItemType: j.itemType,
                                GrossWeight: j.grossWeight,
                                Purity: j.purity,
                                NetOutput: j.outputWeight || 0,
                                Status: j.status,
                                Billed: j.billed ? 'Yes' : 'No',
                                Charge: jobWithCalcs.charge.toFixed(2)
                            };
                        });
                        headers = ['Vendor', 'Date', 'ItemType', 'GrossWeight', 'Purity', 'NetOutput', 'Status', 'Billed', 'Charge'];
                        break;
                    // Add more cases as needed (e.g., inventory)
                    default:
                        throw new Error("Invalid export type.");
                }

                // Ensure data keys match header order
                return {
                    headers,
                    data: data.map(row => headers.map(header => row[header]))
                };
            },

            // --- Vendors ---
            getVendors: (searchTerm = '') => {
                const lowerSearch = searchTerm.toLowerCase();
                // Get jobs to find last job date
                const jobsByVendor = state.meltingJobs.reduce((acc, job) => {
                    if (!acc[job.vendorId] || new Date(job.date) > new Date(acc[job.vendorId])) {
                        acc[job.vendorId] = job.date;
                    }
                    return acc;
                }, {});

                return [...state.vendors]
                    .map(v => ({ ...v, lastJobDate: jobsByVendor[v.id] || 'N/A' }))
                    .filter(v =>
                        v.name.toLowerCase().includes(lowerSearch) ||
                        v.mobile.toLowerCase().includes(lowerSearch)
                    )
                    .sort((a, b) => a.name.localeCompare(b.name));
            },
            addVendor: async (data) => {
                const colRef = ApiService._getVendorsColRef();
                if (!colRef) throw new Error("Database not ready.");
                showSpinner(true);
                try {
                    const newVendor = { ...data, joined: ApiService._getToday() };
                    const docRef = await addDoc(colRef, newVendor);
                    showToast(`âœ… New Vendor Added: ${data.name}`, 'success'); // Real-time feedback
                    return docRef;
                } finally {
                    showSpinner(false);
                }
            },
            updateVendor: async (id, data) => {
                if (!state.userId || !state.appId || !db) throw new Error("Database not ready.");
                showSpinner(true);
                try {
                    const vendorRef = doc(db, `artifacts/${state.appId}/users/${state.userId}/vendors`, id);
                    await setDoc(vendorRef, data, { merge: true });
                    showToast(`âœï¸ Vendor Updated: ${data.name}`, 'info'); // Real-time feedback
                } finally {
                    showSpinner(false);
                }
            },
            deleteVendor: async (id) => {
                if (!state.userId || !state.appId || !db) throw new Error("Database not ready.");
                showSpinner(true);
                try {
                    const hasJobs = state.meltingJobs.some(j => j.vendorId === id);
                    if (hasJobs) {
                        throw new Error("Cannot delete vendor with existing melting jobs.");
                    }
                    const vendorRef = doc(db, `artifacts/${state.appId}/users/${state.userId}/vendors`, id);
                    await deleteDoc(vendorRef);
                    showToast(`ðŸ—‘ï¸ Vendor Deleted.`, 'error'); // Real-time feedback
                } finally {
                    showSpinner(false);
                }
            },

            // --- Melting Jobs ---
            getMeltingJobs: (purityFilter = 'all') => {
                let jobs = state.meltingJobs
                    .map(job => {
                        const vendor = state.vendors.find(v => v.id === job.vendorId);
                        const jobWithCalcs = ApiService._getJobCalculations(job);
                        return { ...jobWithCalcs, vendorName: vendor ? vendor.name : 'Unknown' };
                    })
                    .sort((a, b) => new Date(b.date) - new Date(a.date));

                if (purityFilter !== 'all') {
                    jobs = jobs.filter(j => {
                        if (purityFilter === 'high') return j.purity > 95;
                        if (purityFilter === 'medium') return j.purity >= 90 && j.purity <= 95;
                        if (purityFilter === 'low') return j.purity < 90;
                        return true;
                    });
                }
                return jobs;
            },
            addMeltingJob: async (data) => {
                const colRef = ApiService._getJobsColRef();
                if (!colRef) throw new Error("Database not ready.");
                showSpinner(true);
                try {
                    const vendor = state.vendors.find(v => v.id === data.vendorId);
                    const newJob = {
                        ...data,
                        vendorName: vendor ? vendor.name : 'Unknown',
                        outputWeight: null,
                        status: 'Pending',
                        billed: false
                    };
                    const docRef = await addDoc(colRef, newJob);
                    showToast(`ðŸ”¥ New Melting Job Added for ${vendor ? vendor.name : 'Unknown'}`, 'success'); // Real-time feedback
                    return docRef;
                } finally {
                    showSpinner(false);
                }
            },
            completeMeltingJob: async (id, outputWeight) => {
                if (!state.userId || !state.appId || !db) throw new Error("Database not ready.");
                showSpinner(true);
                try {
                    const job = state.meltingJobs.find(j => j.id === id);
                    if (!job) throw new Error('Job not found');
                    if (outputWeight > job.grossWeight) {
                        throw new Error("Output weight cannot be greater than gross weight.");
                    }
                    const jobRef = doc(db, `artifacts/${state.appId}/users/${state.userId}/meltingJobs`, id);
                    await updateDoc(jobRef, {
                        outputWeight: outputWeight,
                        status: 'Completed'
                    });
                    showToast(`âœ”ï¸ Job ${id.slice(-4)} Completed!`, 'info');
                } finally {
                    showSpinner(false);
                }
            },
            deleteMeltingJob: async (id) => {
                if (!state.userId || !state.appId || !db) throw new Error("Database not ready.");
                showSpinner(true);
                try {
                    const job = state.meltingJobs.find(j => j.id === id);
                    if (job && job.billed) {
                        throw new Error("Cannot delete a job that has been billed.");
                    }
                    const jobRef = doc(db, `artifacts/${state.appId}/users/${state.userId}/meltingJobs`, id);
                    await deleteDoc(jobRef);
                    showToast(`ðŸ—‘ï¸ Job ${id.slice(-4)} Deleted.`, 'error');
                } finally {
                    showSpinner(false);
                }
            },

            // --- Billing ---
            markJobsAsBilled: async (jobIds, vendorName) => {
                if (!state.userId || !state.appId || !db) throw new Error("Database not ready.");
                showSpinner(true);
                try {
                    const batch = writeBatch(db);
                    jobIds.forEach(id => {
                        const jobRef = doc(db, `artifacts/${state.appId}/users/${state.userId}/meltingJobs`, id);
                        batch.update(jobRef, { billed: true });
                    });
                    await batch.commit();
                    showToast(`ðŸ’° Bill Generated for ${vendorName}!`, 'success');
                } finally {
                    showSpinner(false);
                }
            },

            // --- Settings ---
            saveSettings: async (data) => {
                const docRef = ApiService._getSettingsDocRef();
                if (!docRef) throw new Error("Database not ready.");
                showSpinner(true);
                try {
                    await setDoc(docRef, data, { merge: true });
                    showToast(`âš™ï¸ Settings Saved.`, 'info');
                } finally {
                    showSpinner(false);
                }
            },

            // --- NEW: Inventory ---
            getInventory: (searchTerm = '') => {
                const lowerSearch = searchTerm.toLowerCase();
                return [...state.inventory]
                    .filter(i =>
                        i.itemType.toLowerCase().includes(lowerSearch)
                    )
                    .sort((a, b) => a.itemType.localeCompare(b.itemType));
            },
            addInventory: async (data) => {
                const colRef = ApiService._getInventoryColRef();
                if (!colRef) throw new Error("Database not ready.");
                showSpinner(true);
                try {
                    const docRef = await addDoc(colRef, data);
                    showToast(`ðŸ“¦ New Inventory Item Added: ${data.itemType}`, 'success');
                    return docRef;
                } finally {
                    showSpinner(false);
                }
            },
            updateInventory: async (id, data) => {
                if (!state.userId || !state.appId || !db) throw new Error("Database not ready.");
                showSpinner(true);
                try {
                    const docRef = doc(db, `artifacts/${state.appId}/users/${state.userId}/inventory`, id);
                    await setDoc(docRef, data, { merge: true });
                    showToast(`ðŸ“¦ Inventory Updated: ${data.itemType}`, 'info');
                } finally {
                    showSpinner(false);
                }
            },
            deleteInventory: async (id) => {
                if (!state.userId || !state.appId || !db) throw new Error("Database not ready.");
                showSpinner(true);
                try {
                    const docRef = doc(db, `artifacts/${state.appId}/users/${state.userId}/inventory`, id);
                    await deleteDoc(docRef);
                    showToast(`ðŸ—‘ï¸ Inventory Item Deleted.`, 'error');
                } finally {
                    showSpinner(false);
                }
            },

            // --- NEW: Purchase Orders ---
            getPurchaseOrders: (searchTerm = '') => {
                 const lowerSearch = searchTerm.toLowerCase();
                return [...state.purchaseOrders]
                    .filter(po =>
                        po.supplierName.toLowerCase().includes(lowerSearch)
                    )
                    .sort((a, b) => new Date(b.date) - new Date(a.date));
            },
            addPurchaseOrder: async (data) => {
                const colRef = ApiService._getPurchaseOrdersColRef();
                if (!colRef) throw new Error("Database not ready.");
                showSpinner(true);
                try {
                    const docRef = await addDoc(colRef, data);
                    showToast(`ðŸ›’ New Purchase Order Added: ${data.supplierName}`, 'success');
                    return docRef;
                } finally {
                    showSpinner(false);
                }
            },
            updatePurchaseOrder: async (id, data) => {
                if (!state.userId || !state.appId || !db) throw new Error("Database not ready.");
                showSpinner(true);
                try {
                    const docRef = doc(db, `artifacts/${state.appId}/users/${state.userId}/purchaseOrders`, id);
                    await setDoc(docRef, data, { merge: true });
                    showToast(`âœï¸ Purchase Order Updated: ${data.supplierName}`, 'info');
                } finally {
                    showSpinner(false);
                }
            },
            deletePurchaseOrder: async (id) => {
                if (!state.userId || !state.appId || !db) throw new Error("Database not ready.");
                showSpinner(true);
                try {
                    const docRef = doc(db, `artifacts/${state.appId}/users/${state.userId}/purchaseOrders`, id);
                    await deleteDoc(docRef);
                    showToast(`ðŸ—‘ï¸ Purchase Order Deleted.`, 'error');
                } finally {
                    showSpinner(false);
                }
            },

            // --- NEW: User Management (Simulated) ---
            getUserManagementData: () => {
                return [...state.appUsers].sort((a, b) => a.name.localeCompare(b.name));
            },
            toggleUserActiveStatus: async (id, currentStatus) => {
                if (!state.userId || !state.appId || !db) throw new Error("Database not ready.");
                showSpinner(true);
                try {
                    const docRef = doc(db, `artifacts/${state.appId}/users/${state.userId}/appUsers`, id);
                    await updateDoc(docRef, { isActive: !currentStatus });
                    showToast(`ðŸ‘¥ User status changed to ${!currentStatus ? 'Active' : 'Inactive'}.`, 'info');
                } finally {
                    showSpinner(false);
                }
            },
            // Initial setup for the main user in the simulated collection
            setupInitialUser: async (user) => {
                 if (!state.userId || !state.appId || !db) return;
                 const userDocRef = doc(db, `artifacts/${state.appId}/users/${state.userId}/appUsers`, user.uid);
                 const docSnap = await getDoc(userDocRef);

                 if (!docSnap.exists()) {
                     await setDoc(userDocRef, {
                         name: user.displayName || "Admin User",
                         email: user.email || "N/A",
                         role: "Admin",
                         isActive: true,
                         createdAt: ApiService._getToday()
                     });
                 }
            }
        };

        // ==========================================================
        // DOM SELECTORS
        // ==========================================================
        const $ = (selector) => document.querySelector(selector);
        const $$ = (selector) => document.querySelectorAll(selector);

        const globalSpinner = $('#global-spinner');
        const loginScreen = $('#login-screen');
        const authLoader = $('#auth-loader');

        // Auth Forms
        const loginForm = $('#login-form');
        const loginError = $('#login-error');
        const signupForm = $('#signup-form');
        const signupError = $('#signup-error');
        const showSignupButton = $('#show-signup');
        const showLoginButton = $('#show-login');
        const forgotPasswordForm = $('#forgot-password-form');
        const forgotError = $('#forgot-error');
        const forgotSuccess = $('#forgot-success');
        const showForgotPasswordButton = $('#show-forgot-password');
        const showLoginFromForgotButton = $('#show-login-from-forgot');
        const loginLogo = $('#login-logo');

        const mainApp = $('#main-app');
        const sidebar = $('#sidebar');
        const sidebarTitle = $('#sidebar-title');
        const sidebarToggleMobile = $('#sidebar-toggle-mobile');
        const mobileSidebarOverlay = $('#mobile-sidebar-overlay');
        const mainContentWrapper = $('#main-content-wrapper');
        const pageTitle = $('#page-title');
        const mainAddButton = $('#main-add-button');
        const mobileFloatAddButton = $('#mobile-float-add-button');
        // const themeToggleButton = $('#theme-toggle-button'); // REMOVED
        const pageContents = $$('.page-content');
        const userName = $('#user-name');
        const userAvatar = $('#user-avatar');
        const userIdDisplay = $('#user-id-display');
        const logoutButton = $('#logout-button');
        const toast = $('#toast-notification');
        const toastMessage = $('#toast-message');
        const notificationsToggle = $('#notifications-toggle');
        const notificationBadge = $('#notification-badge');

        // Modals
        const formModal = $('#form-modal');
        const modalTitle = $('#modal-title');
        const modalForm = $('#modal-form');
        const modalCloseButton = $('#modal-close-button');
        const modalCancelButton = $('#modal-cancel-button');
        const modalSaveButton = $('#modal-save-button');
        const deleteModal = $('#delete-modal');
        const deleteCancelButton = $('#delete-cancel-button');
        const deleteConfirmButton = $('#delete-confirm-button');
        const billModal = $('#bill-modal');
        const billModalCloseButton = $('#bill-modal-close-button');
        const billPdfButton = $('#bill-pdf-button');
        const billPrintBrowserButton = $('#bill-print-browser-button'); // NEW

        // Page Inputs/Elements
        const vendorSearch = $('#vendor-search');
        const purityFilter = $('#purity-filter');
        const inventorySearch = $('#inventory-search');
        const poSearch = $('#po-search');
        const billingVendorSelect = $('#billing-vendor-select');
        const billingJobsSection = $('#billing-jobs-section');
        const billingVendorName = $('#billing-vendor-name');
        const billingTableBody = $('#billing-table-body');
        const billingEmptyState = $('#billing-empty-state');
        const billingTotalCharge = $('#billing-total-charge');
        const billingSelectAll = $('#bill-select-all');
        const generateBillButton = $('#generate-bill-button');
        const settingsForm = $('#settings-form');
        const profileNameForm = $('#profile-name-form');
        const profileChangePasswordButton = $('#profile-change-password-button');
        const passwordResetSuccess = $('#password-reset-success');


        // ==========================================================
        // THEME MANAGEMENT (Simplified for Light Theme Only)
        // ==========================================================
        function applyTheme(theme) {
            // Force light mode
            document.documentElement.classList.remove('dark');
            localStorage.setItem('theme', 'light');
            updateChartTheme();
        }

        function initTheme() {
            // Always initialize to light theme
            applyTheme('light');
        }

        function getChartColors() {
            // Updated colors to soft, professional, vibrant palette
            return {
                // Text/Axis/Grid colors for contrast on white card backgrounds
                chartTextColor: '#374151', // Dark Gray
                chartGridColor: '#e5e7eb', // Light Gray
                // Primary/Secondary colors (Bright for contrast)
                primary: 'rgba(37, 99, 235, 0.9)', // Blue-600
                secondary: 'rgba(20, 184, 166, 0.9)', // Teal-500 (#14b8a6)
                orange: 'rgba(249, 115, 22, 0.9)', // Orange-500
                purple: 'rgba(124, 58, 237, 0.9)', // Purple-600
            }
        }

        function updateChartTheme() {
            const colors = getChartColors();

            // Set Chart.js defaults for visibility on white card backgrounds
            Chart.defaults.color = colors.chartTextColor;
            Chart.defaults.borderColor = colors.chartGridColor;

            const chartsToUpdate = Object.values(CHARTS).filter(chart => chart);

            chartsToUpdate.forEach(chart => {
                const options = chart.options;

                // Ensure legend labels are dark
                if (options.plugins && options.plugins.legend && options.plugins.legend.labels) {
                    options.plugins.legend.labels.color = colors.chartTextColor;
                }

                // Update scale colors for legibility on white background
                Object.keys(options.scales || {}).forEach(scaleId => {
                    const scale = options.scales[scaleId];
                    if (scale.ticks) scale.ticks.color = colors.chartTextColor;
                    if (scale.grid) scale.grid.color = colors.chartGridColor;
                    if (scale.title) scale.title.color = colors.chartTextColor;
                });

                // Don't destroy/recreate unless necessary (handled in render functions)
                chart.update();
            });
        }


        // ==========================================================
        // NAVIGATION & UI
        // ==========================================================

        const navLinks = [
            { page: 'dashboard', label: 'Dashboard', icon: 'layout-dashboard', group: 'Core' },
            { page: 'vendors', label: 'Vendor Management', icon: 'users', group: 'Core' },
            { page: 'melting-records', label: 'Melting Records', icon: 'flame', group: 'Core' },
            { page: 'inventory', label: 'Inventory Tracking', icon: 'package-open', group: 'Core' },
            { page: 'purchase-orders', label: 'Purchase Orders', icon: 'shopping-cart', group: 'Core' },
            { page: 'billing', label: 'Billing System', icon: 'receipt', group: 'Core' },

            { page: 'reports', label: 'Reports & Analytics', icon: 'bar-chart-3', group: 'Reporting' },

            { page: 'user-mgmt', label: 'User Management', icon: 'shield-check', group: 'Admin' },
            { page: 'notifications', label: 'Notifications', icon: 'bell', group: 'Admin' },

            { page: 'profile', label: 'My Profile', icon: 'user', group: 'Config' },
            { page: 'settings', label: 'Settings', icon: 'settings', group: 'Config' }
        ];

        function buildSidebar() {
            const navContainer = $('nav');
            navContainer.innerHTML = '';

            const groups = navLinks.reduce((acc, link) => {
                if (!acc[link.group]) acc[link.group] = [];
                acc[link.group].push(link);
                return acc;
            }, {});

            let html = '';
            for (const group in groups) {
                // Skip group title for 'Core' for a cleaner look
                if (group !== 'Core') {
                     html += `<p class="text-xs font-semibold text-gray-500 uppercase tracking-wider mt-4 mb-1 px-4 font-inter">${group}</p>`;
                }

                groups[group].forEach(link => {
                    html += `
                        <a href="#" class="sidebar-link ${link.page === 'dashboard' ? 'active' : ''} text-gray-600 hover:bg-gray-100 hover:text-gray-900 group flex items-center px-4 py-3 text-base font-medium rounded-2xl transition-colors duration-150" data-page="${link.page}">
                            <i data-lucide="${link.icon}" class="mr-3 h-5 w-5 flex-shrink-0 text-gray-400 group-hover:text-gray-500"></i>
                            <span id="label-${link.page}" class="whitespace-nowrap">${link.label}</span>
                        </a>
                    `;
                });
            }
            navContainer.innerHTML = html;

            $$('.sidebar-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    // Changed to new showPage logic (Step 4)
                    showPage(link.dataset.page); 
                    // Close sidebar on mobile after click
                    if (window.innerWidth < 768) toggleSidebar(false); 
                });
            });

            lucide.createIcons();
        }

        function toggleSidebar(expand) {
             // For desktop only:
             if (window.innerWidth >= 768) {
                 const isExpanded = expand === undefined ? sidebar.classList.contains('sidebar-expanded') : expand;
                 if (isExpanded) {
                     sidebar.classList.replace('sidebar-expanded', 'sidebar-collapsed');
                     mainContentWrapper.classList.replace('pl-72', 'pl-20'); 
                     sidebarTitle.classList.add('hidden');
                     $$('nav span').forEach(span => span.classList.add('hidden'));
                 } else {
                     sidebar.classList.replace('sidebar-collapsed', 'sidebar-expanded');
                     mainContentWrapper.classList.replace('pl-20', 'pl-72'); 
                     sidebarTitle.classList.remove('hidden');
                     $$('nav span').forEach(span => span.classList.remove('hidden'));
                 }
             } else {
                 // For mobile only (using the classes defined in Step 1/3)
                 if (expand === false) {
                     sidebar.classList.remove('open');
                     mobileSidebarOverlay.classList.add('hidden');
                 } else {
                     // The toggle logic is now handled by the separate listener below (Step 3)
                     // This function is kept minimal for mobile logic consistency when called from nav links
                 }
             }
        }

        function showPage(pageId) {
            if (!state.isAuthReady) return;

            state.currentPage = pageId;
            
            // NEW Page toggle logic (Step 4)
            pageContents.forEach(page => {
                page.classList.remove('active');
                page.classList.add('hidden');
            });

            const newPage = $(`#page-${pageId}`);
            if (newPage) {
                newPage.classList.remove('hidden');
                newPage.classList.add('active'); // Set the active class
            }

            $$('.sidebar-link').forEach(link => {
                link.classList.toggle('active', link.dataset.page === pageId);
            });

            pageTitle.textContent = navLinks.find(l => l.page === pageId)?.label || 'Dashboard';
            updateMainButton(pageId);

            const renderFunctionName = `render${pageId.charAt(0).toUpperCase() + pageId.slice(1).replace(/-/g, '')}`;

            if (pageId !== 'profile' && passwordResetSuccess) {
                passwordResetSuccess.classList.add('hidden');
                passwordResetSuccess.textContent = '';
            }

            // Centralized render call
            if (window[renderFunctionName]) {
                window[renderFunctionName]();
            }

            lucide.createIcons({
                 elements: [newPage, ...newPage.querySelectorAll('[data-lucide]')]
            });
        }

        function updateMainButton(pageId) {
            const config = {
                'vendors': { text: 'Add Vendor', action: () => openModal('vendor') },
                'melting-records': { text: 'Add Job', action: () => openModal('meltingJob') },
                'inventory': { text: 'Add Item', action: () => openModal('inventoryItem') }, // NEW
                'purchase-orders': { text: 'Add Order', action: () => openModal('purchaseOrder') }, // NEW
            };

            const buttonConfig = config[pageId];

            if (buttonConfig) {
                // Desktop Button
                mainAddButton.innerHTML = `
                    <i data-lucide="plus" class="w-5 h-5 mr-2"></i>
                    ${buttonConfig.text}
                `;
                mainAddButton.onclick = buttonConfig.action;
                mainAddButton.classList.remove('hidden');

                // Mobile Floating Button
                mobileFloatAddButton.onclick = buttonConfig.action;
                mobileFloatAddButton.classList.remove('hidden');

                lucide.createIcons({
                    elements: [mainAddButton.querySelector('i'), mobileFloatAddButton.querySelector('i')]
                });
            } else {
                mainAddButton.classList.add('hidden');
                mobileFloatAddButton.classList.add('hidden');
            }
        }

        // ==========================================================
        // TOAST & SPINNER
        // ==========================================================

        function showToast(message, type = 'success') {
            toastMessage.textContent = message;
            toast.classList.remove('bg-green-600', 'bg-red-600', 'bg-blue-600');
            toast.classList.toggle('bg-green-600', type === 'success');
            toast.classList.toggle('bg-red-600', type === 'error');
            toast.classList.toggle('bg-blue-600', type === 'info');
            toast.classList.remove('translate-x-[120%]');
            setTimeout(() => toast.classList.add('translate-x-[120%]'), 3000);
        }

        function showSpinner(show) {
            if (show) {
                globalSpinner.classList.add('open');
                globalSpinner.classList.remove('opacity-0', 'pointer-events-none');
            } else {
                globalSpinner.classList.remove('open');
                globalSpinner.classList.add('opacity-0', 'pointer-events-none');
            }
        }

        // Animated Counter
        function animateCounter(el, to, duration = 1000, isWeight = false) {
            if (!el) return;
            const fixed = isWeight ? 2 : 0;
            const from = parseFloat(el.innerText.replace(/,/g, '').replace(' g', '')) || 0;

            if (from === to) {
                 el.innerText = to.toLocaleString(undefined, {minimumFractionDigits: fixed, maximumFractionDigits: fixed}) + (isWeight ? ' g' : '');
                 return;
            }

            let startTime = null;

            const step = (timestamp) => {
                if (!startTime) startTime = timestamp;
                const progress = Math.min((timestamp - startTime) / duration, 1);
                const current = from + (to - from) * progress;
                el.innerText = current.toLocaleString(undefined, {minimumFractionDigits: fixed, maximumFractionDigits: fixed}) + (isWeight ? ' g' : '');
                if (progress < 1) {
                    window.requestAnimationFrame(step);
                } else {
                    el.innerText = to.toLocaleString(undefined, {minimumFractionDigits: fixed, maximumFractionDigits: fixed}) + (isWeight ? ' g' : '');
                }
            };
            window.requestAnimationFrame(step);
        }

        // ==========================================================
        // MODAL MANAGEMENT
        // ==========================================================

        async function openModal(type, id = null) {
            modalForm.dataset.id = id || '';
            modalForm.dataset.type = type;
            let title = '';
            let formHtml = '';
            let data = {};

            // All inputs use light theme classes
            const inputClass = "mt-1 block w-full rounded-2xl border-gray-300 bg-gray-50 text-gray-900 shadow-sm sm:text-base px-4 py-3 focus:border-blue-600 focus:ring-blue-600 font-inter";
            const labelClass = "block text-sm font-medium text-gray-700";

            if (id) {
                // Since data is already loaded via onSnapshot, synchronous find is fine
                switch (type) {
                    case 'vendor': data = state.vendors.find(v => v.id === id); break;
                    case 'completeJob': data = state.meltingJobs.find(j => j.id === id); break;
                    case 'inventoryItem': data = state.inventory.find(i => i.id === id); break;
                    case 'purchaseOrder': data = state.purchaseOrders.find(po => po.id === id); break;
                }
                if (!data) { showToast('Error: Could not find record to edit.', 'error'); return; }
            }

            switch (type) {
                case 'vendor':
                    title = id ? 'Edit Vendor' : 'Add Vendor';
                    formHtml = `
                        <div class="space-y-4">
                            <div><label class="${labelClass}">Full Name</label>
                                <input type="text" name="name" value="${data.name || ''}" required class="${inputClass}"></div>
                            <div><label class="${labelClass}">Mobile</label>
                                <input type="tel" name="mobile" value="${data.mobile || ''}" required class="${inputClass}"></div>
                            <div><label class="${labelClass}">Address</label>
                                <input type="text" name="address" value="${data.address || ''}" class="${inputClass}"></div>
                        </div>
                    `;
                    break;
                case 'meltingJob':
                    title = 'Add New Melting Record';
                    const vendors = state.vendors;
                    if (vendors.length === 0) { showToast('Please add a vendor first.', 'error'); return; }
                    const vendorOptions = vendors.map(v => `<option value="${v.id}">${v.name}</option>`).join('');
                    formHtml = `
                        <div class="space-y-4">
                            <div><label class="${labelClass}">Vendor</label>
                                <select name="vendorId" required class="${inputClass}"><option value="">Select a vendor...</option>${vendorOptions}</select></div>
                            <div><label class="${labelClass}">Date</label>
                                <input type="date" name="date" value="${ApiService._getToday()}" required class="${inputClass}"></div>
                            <div><label class="${labelClass}">Item Type</label>
                                <input type="text" name="itemType" placeholder="e.g., Scrap, Bars, Rings" required class="${inputClass}"></div>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="${labelClass}">Gross Weight (g)</label>
                                    <input type="number" step="0.01" name="grossWeight" required class="${inputClass}"></div>
                                <div><label class="${labelClass}">Purity (%)</label>
                                    <input type="number" step="0.01" name="purity" value="90.0" required class="${inputClass}"></div>
                            </div>
                        </div>
                    `;
                    break;
                case 'completeJob':
                    title = 'Complete Melting Job';
                    formHtml = `
                        <div class="space-y-4">
                            <h4 class="text-base font-medium text-gray-600 font-inter">Job for: ${data.vendorName || 'Unknown'}</h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="${labelClass}">Gross Weight (g)</label>
                                    <input type="number" value="${data.grossWeight}" disabled class="${inputClass} bg-gray-200 opacity-70"></div>
                                <div><label class="${labelClass}">Item Type</label>
                                    <input type="text" value="${data.itemType}" disabled class="${inputClass} bg-gray-200 opacity-70"></div>
                            </div>
                            <div><label class="${labelClass}">Enter Net Output (g)</label>
                                <input type="number" step="0.01" name="outputWeight" required class="${inputClass} focus:border-blue-600 focus:ring-blue-600"></div>
                        </div>
                    `;
                    break;
                case 'inventoryItem': // NEW
                    title = id ? 'Edit Inventory Item' : 'Add New Inventory Item';
                    formHtml = `
                        <div class="space-y-4">
                            <div><label class="${labelClass}">Item Type</label>
                                <input type="text" name="itemType" value="${data.itemType || ''}" required class="${inputClass}"></div>
                            <div><label class="${labelClass}">Purity (%)</label>
                                <input type="number" step="0.01" name="purity" value="${data.purity || '90.0'}" required class="${inputClass}"></div>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="${labelClass}">Weight per Item (g)</label>
                                    <input type="number" step="0.01" name="weight" value="${data.weight || ''}" required class="${inputClass}"></div>
                                <div><label class="${labelClass}">Available Quantity</label>
                                    <input type="number" step="1" name="quantity" value="${data.quantity || '1'}" required class="${inputClass}"></div>
                            </div>
                        </div>
                    `;
                    break;
                case 'purchaseOrder': // NEW
                    title = id ? 'Edit Purchase Order' : 'Add New Purchase Order';
                    const poStatusOptions = ['Pending', 'Paid'].map(status =>
                        `<option value="${status}" ${data.paymentStatus === status ? 'selected' : ''}>${status}</option>`
                    ).join('');
                    formHtml = `
                        <div class="space-y-4">
                            <div><label class="${labelClass}">Supplier Name</label>
                                <input type="text" name="supplierName" value="${data.supplierName || ''}" required class="${inputClass}"></div>
                            <div><label class="${labelClass}">Order Date</label>
                                <input type="date" name="date" value="${data.date || ApiService._getToday()}" required class="${inputClass}"></div>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="${labelClass}">Total Weight (g)</label>
                                    <input type="number" step="0.01" name="totalWeight" value="${data.totalWeight || ''}" required class="${inputClass}"></div>
                                <div><label class="${labelClass}">Total Amount (â‚¹)</label>
                                    <input type="number" step="0.01" name="totalAmount" value="${data.totalAmount || ''}" required class="${inputClass}"></div>
                            </div>
                            <div><label class="${labelClass}">Payment Status</label>
                                <select name="paymentStatus" required class="${inputClass}">${poStatusOptions}</select></div>
                        </div>
                    `;
                    break;
            }

            modalTitle.textContent = title;
            modalForm.innerHTML = formHtml;
            formModal.classList.add('open');
            formModal.classList.remove('opacity-0', 'pointer-events-none');
        }

        function closeModal() {
            formModal.classList.remove('open');
            formModal.classList.add('opacity-0', 'pointer-events-none');
            modalForm.reset();
        }

        function openDeleteModal(id, deleteFunction) {
            state.deleteHandler = () => deleteFunction(id);
            deleteModal.classList.add('open');
            deleteModal.classList.remove('opacity-0', 'pointer-events-none');
        }

        function closeDeleteModal() {
            state.deleteHandler = null;
            deleteModal.classList.remove('open');
            deleteModal.classList.add('opacity-0', 'pointer-events-none');
        }

        async function handleFormSubmit(e) {
            e.preventDefault();
            const id = e.target.dataset.id;
            const type = e.target.dataset.type;
            const formData = new FormData(e.target);
            const data = {};

            for (let [key, value] of formData.entries()) {
                const numFields = ['grossWeight', 'purity', 'outputWeight', 'weight', 'quantity', 'totalWeight', 'totalAmount'];
                data[key] = numFields.includes(key) ? parseFloat(value) : value;
            }

            try {
                switch (type) {
                    case 'vendor':
                        await (id ? ApiService.updateVendor(id, data) : ApiService.addVendor(data));
                        break;
                    case 'meltingJob':
                        await ApiService.addMeltingJob(data);
                        break;
                    case 'completeJob':
                        await ApiService.completeMeltingJob(id, data.outputWeight);
                        break;
                    case 'inventoryItem': // NEW
                        await (id ? ApiService.updateInventory(id, data) : ApiService.addInventory(data));
                        break;
                    case 'purchaseOrder': // NEW
                        await (id ? ApiService.updatePurchaseOrder(id, data) : ApiService.addPurchaseOrder(data));
                        break;
                }
                closeModal();
            } catch (error) {
                console.error('Save error:', error);
                showToast(error.message, 'error');
            }
        }

        async function handleDeleteConfirm() {
            if (state.deleteHandler) {
                try {
                    await state.deleteHandler();
                    closeDeleteModal();
                } catch (error) {
                    console.error('Delete error:', error);
                    showToast(error.message, 'error');
                }
            }
        }

        // ==========================================================
        // RENDER FUNCTIONS (Optimized for real-time updates)
        // ==========================================================

        function updateDashboardCharts() {
            const chartData = ApiService.getDashboardChart();
            const colors = getChartColors();
            const ctx = $('#melting-chart').getContext('2d');

            if (CHARTS.melting) {
                // Update existing chart data and redraw
                CHARTS.melting.data.labels = chartData.labels;
                CHARTS.melting.data.datasets[0].data = chartData.grossData;
                CHARTS.melting.data.datasets[1].data = chartData.netData;
                CHARTS.melting.update();
            } else {
                // Initialize if not present (only happens on initial dashboard load)
                CHARTS.melting = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: chartData.labels,
                        datasets: [
                            {
                                label: 'Gross Weight (g)',
                                data: chartData.grossData,
                                backgroundColor: colors.primary,
                                borderColor: colors.primary,
                                borderWidth: 1
                            },
                            {
                                label: 'Net Weight (g)',
                                data: chartData.netData,
                                backgroundColor: colors.secondary,
                                borderColor: colors.secondary,
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { position: 'top', labels: { color: colors.chartTextColor } } },
                        scales: {
                            y: { beginAtZero: true, ticks: { color: colors.chartTextColor }, grid: { color: colors.chartGridColor } },
                            x: { ticks: { color: colors.chartTextColor }, grid: { color: colors.chartGridColor } }
                        }
                    }
                });
            }
        }

        window.renderDashboard = () => {
            if (state.currentPage !== 'dashboard') return;

            const stats = ApiService.getDashboardStats();

            animateCounter($('#stat-total-vendors'), stats.totalVendors);
            animateCounter($('#stat-month-jobs'), stats.monthJobs);
            animateCounter($('#stat-pending-jobs'), stats.pendingJobs);
            animateCounter($('#stat-unbilled-jobs'), stats.unbilledJobs);
            animateCounter($('#stat-total-net-output'), stats.totalNetOutput, 1000, true);

            updateDashboardCharts();
        }

        window.renderVendors = () => {
            if (state.currentPage !== 'vendors') return;

            const searchTerm = vendorSearch.value;
            const vendors = ApiService.getVendors(searchTerm);
            const tableBody = $('#vendors-table-body');
            const emptyState = $('#vendors-empty-state');

            if (vendors.length === 0) {
                tableBody.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            tableBody.innerHTML = vendors.map((v, index) => `
                <tr id="row-${v.id}" class="${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'} hover:bg-gray-100 transition-colors duration-150">
                    <td class="px-6 py-4 whitespace-nowrap text-base font-medium text-gray-900">${v.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-base text-gray-600 font-inter">${v.mobile}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-base text-gray-600 font-inter">${v.address}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-base text-gray-600 font-inter">${v.joined}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-base text-gray-600 font-inter">${v.lastJobDate}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-3">
                        <button class="action-edit text-blue-600 hover:text-blue-700 p-1 rounded-2xl transition-colors" data-id="${v.id}" data-type="vendor" title="Edit Vendor"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                        <button class="action-delete text-red-600 hover:text-red-700 p-1 rounded-2xl transition-colors" data-id="${v.id}" data-type="vendor" title="Delete Vendor"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </td>
                </tr>
            `).join('');
            lucide.createIcons();
        }

        window.renderMeltingrecords = () => {
            if (state.currentPage !== 'melting-records') return;

            const jobs = ApiService.getMeltingJobs(purityFilter.value);
            const tableBody = $('#melting-jobs-table-body');
            const emptyState = $('#melting-jobs-empty-state');

            if (jobs.length === 0) {
                tableBody.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            tableBody.innerHTML = jobs.map((j, index) => {
                const statusColor = j.status === 'Completed' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800';

                let actionButton, deleteButton;
                if (j.status === 'Pending') {
                    actionButton = `<button class="action-complete text-blue-600 hover:text-blue-700 p-1 rounded-2xl transition-colors" data-id="${j.id}" data-type="completeJob" title="Mark Complete"><i data-lucide="check-circle" class="w-4 h-4"></i></button>`;
                    deleteButton = `<button class="action-delete text-red-600 hover:text-red-700 p-1 rounded-2xl transition-colors" data-id="${j.id}" data-type="meltingJob" title="Delete Job"><i data-lucide="trash-2" class="w-4 h-4"></i></button>`;
                } else if (!j.billed) {
                    actionButton = `<span class="text-gray-400 flex items-center p-1" title="Ready to Bill"><i data-lucide="dollar-sign" class="w-4 h-4 mr-1"></i> Ready</span>`;
                    deleteButton = `<button class="action-delete text-red-600 hover:text-red-700 p-1 rounded-2xl transition-colors" data-id="${j.id}" data-type="meltingJob" title="Delete Job"><i data-lucide="trash-2" class="w-4 h-4"></i></button>`;
                } else {
                    actionButton = `<span class="text-green-600 flex items-center p-1" title="Billed"><i data-lucide="receipt-text" class="w-4 h-4 mr-1"></i> Billed</span>`;
                    deleteButton = `<button disabled class="text-gray-300 p-1" title="Billed jobs cannot be deleted"><i data-lucide="trash-2" class="w-4 h-4"></i></button>`;
                }

                return `
                    <tr id="row-${j.id}" class="${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'} hover:bg-gray-100 transition-colors duration-150">
                        <td class="px-6 py-4 whitespace-nowrap text-base font-medium text-gray-900">${j.vendorName}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-base text-gray-600 font-inter">${j.date}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-base text-gray-600 font-inter">${j.itemType}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-base text-gray-600 font-inter">${ApiService._formatGrams(j.grossWeight)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-base text-gray-600 font-inter">${ApiService._formatPercent(j.purity)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-base font-medium text-gray-700 font-inter">${ApiService._formatGrams(j.outputWeight)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-base">
                            <span class="px-2 inline-flex text-sm leading-5 font-semibold rounded-full ${statusColor} font-inter">${j.status}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium flex justify-end space-x-3">
                            ${actionButton}
                            ${deleteButton}
                        </td>
                    </tr>
                `;
            }).join('');
            lucide.createIcons();
        }

        window.renderInventory = () => { // NEW
            if (state.currentPage !== 'inventory') return;

            const searchTerm = inventorySearch.value;
            const inventory = ApiService.getInventory(searchTerm);
            const tableBody = $('#inventory-table-body');
            const emptyState = $('#inventory-empty-state');
            const threshold = state.settings.lowStockThreshold;

            const totalWeight = inventory.reduce((sum, item) => sum + (item.weight * item.quantity), 0);
            const lowStockCount = inventory.filter(item => item.quantity <= threshold).length;

            animateCounter($('#inv-stat-total-weight'), totalWeight, 1000, true);
            animateCounter($('#inv-stat-total-items'), inventory.length);
            animateCounter($('#inv-stat-low-stock'), lowStockCount);

            if (inventory.length === 0) {
                tableBody.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            tableBody.innerHTML = inventory.map((i, index) => {
                const stockColor = i.quantity <= threshold ? 'text-red-600 font-bold' : 'text-gray-900 font-medium';
                return `
                    <tr id="row-${i.id}" class="${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'} hover:bg-gray-100 transition-colors duration-150">
                        <td class="px-6 py-4 whitespace-nowrap text-base font-medium text-gray-900">${i.itemType}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-base text-gray-600 font-inter">${ApiService._formatGrams(i.weight)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-base text-gray-600 font-inter">${ApiService._formatPercent(i.purity)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-base ${stockColor} font-inter">${i.quantity}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-3">
                            <button class="action-edit text-blue-600 hover:text-blue-700 p-1 rounded-2xl transition-colors" data-id="${i.id}" data-type="inventoryItem" title="Edit Item"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                            <button class="action-delete text-red-600 hover:text-red-700 p-1 rounded-2xl transition-colors" data-id="${i.id}" data-type="inventoryItem" title="Delete Item"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </td>
                    </tr>
                `;
            }).join('');
            lucide.createIcons();
        }

        window.renderPurchaseorders = () => { // NEW
            if (state.currentPage !== 'purchase-orders') return;

            const searchTerm = poSearch.value;
            const orders = ApiService.getPurchaseOrders(searchTerm);
            const tableBody = $('#purchase-orders-table-body');
            const emptyState = $('#purchase-orders-empty-state');

            const totalOrders = orders.length;
            const pendingOrders = orders.filter(po => po.paymentStatus === 'Pending').length;
            const totalWeight = orders.reduce((sum, po) => sum + po.totalWeight, 0);

            animateCounter($('#po-stat-total-orders'), totalOrders);
            animateCounter($('#po-stat-pending-orders'), pendingOrders);
            animateCounter($('#po-stat-total-weight'), totalWeight, 1000, true);

            if (orders.length === 0) {
                tableBody.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            tableBody.innerHTML = orders.map((po, index) => {
                const statusColor = po.paymentStatus === 'Paid' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800';
                return `
                    <tr id="row-${po.id}" class="${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'} hover:bg-gray-100 transition-colors duration-150">
                        <td class="px-6 py-4 whitespace-nowrap text-base font-medium text-gray-900">${po.supplierName}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-base text-gray-600 font-inter">${po.date}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-base text-gray-600 font-inter">${ApiService._formatGrams(po.totalWeight)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-base text-gray-600 font-inter">${ApiService._formatCurrency(po.totalAmount)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-base">
                            <span class="px-2 inline-flex text-sm leading-5 font-semibold rounded-full ${statusColor} font-inter">${po.paymentStatus}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-3">
                            <button class="action-edit text-blue-600 hover:text-blue-700 p-1 rounded-2xl transition-colors" data-id="${po.id}" data-type="purchaseOrder" title="Edit Order"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                            <button class="action-delete text-red-600 hover:text-red-700 p-1 rounded-2xl transition-colors" data-id="${po.id}" data-type="purchaseOrder" title="Delete Order"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </td>
                    </tr>
                `;
            }).join('');
            lucide.createIcons();
        }

        window.renderBilling = () => {
            if (state.currentPage !== 'billing') return;

            const vendors = state.vendors;
            billingVendorSelect.innerHTML = '<option value="">Select a vendor...</option>' +
                vendors.map(v => `<option value="${v.id}">${v.name}</option>`).join('');

            // Re-render table based on current selection
            renderBillingTable(billingVendorSelect.value);
        }

        function renderBillingTable(vendorId) {
            if (!vendorId) {
                billingJobsSection.classList.add('hidden');
                return;
            }

            const vendor = state.vendors.find(v => v.id === vendorId);
            if (!vendor) {
                 billingJobsSection.classList.add('hidden');
                 return;
            }

            const allJobs = ApiService.getMeltingJobs();
            const jobs = allJobs.filter(j => j.vendorId === vendorId && j.status === 'Completed' && !j.billed);

            billingVendorName.textContent = `Unbilled Jobs for: ${vendor.name}`;
            billingJobsSection.classList.remove('hidden');

            if (jobs.length === 0) {
                billingTableBody.innerHTML = '';
                billingEmptyState.classList.remove('hidden');
                updateBillingTotal();
                return;
            }

            billingEmptyState.classList.add('hidden');
            billingTableBody.innerHTML = jobs.map((j, index) => `
                <tr id="bill-row-${j.id}" class="${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'} hover:bg-gray-100 transition-colors duration-150">
                    <td class="py-4 pl-4 pr-3 text-sm">
                        <input type="checkbox" data-charge="${j.charge}" data-gross="${j.grossWeight}" data-net="${j.outputWeight}" data-job-id="${j.id}" class="bill-job-checkbox h-5 w-5 rounded-md border-gray-400 bg-gray-100 text-blue-600 focus:ring-blue-600 focus:ring-offset-white">
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-base text-gray-600 font-inter">${j.date}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-base text-gray-600 font-inter">${j.itemType}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-base text-gray-600 font-inter">${ApiService._formatGrams(j.grossWeight)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-base text-gray-600 font-inter">${ApiService._formatGrams(j.outputWeight)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-base font-medium text-gray-700 font-inter">${ApiService._formatCurrency(j.charge)}</td>
                </tr>
            `).join('');
            updateBillingTotal();
            lucide.createIcons();
        }

        function updateBillingTotal() {
            const checkedBoxes = $$('.bill-job-checkbox:checked');
            let totalCharge = 0;
            let totalGross = 0;
            let totalNet = 0;

            checkedBoxes.forEach(box => {
                totalCharge += parseFloat(box.dataset.charge);
                totalGross += parseFloat(box.dataset.gross);
                totalNet += parseFloat(box.dataset.net);
            });

            billingTotalCharge.textContent = ApiService._formatCurrency(totalCharge);
            $('#bill-summary-gross').textContent = ApiService._formatGrams(totalGross);
            $('#bill-summary-net').textContent = ApiService._formatGrams(totalNet);
            generateBillButton.disabled = checkedBoxes.length === 0;
        }

        function updateReportCharts() {
            const jobs = state.meltingJobs.map(ApiService._getJobCalculations).filter(j => j.status === 'Completed');
            const colors = getChartColors();

            // --- 1. Monthly Melting Trend Data ---
            const monthlyData = jobs.reduce((acc, job) => {
                const monthYear = job.date.substring(0, 7);
                const netWeight = job.outputWeight || 0;
                acc[monthYear] = (acc[monthYear] || 0) + netWeight;
                return acc;
            }, {});
            const sortedMonths = Object.keys(monthlyData).sort();

            // Update Chart 1
            if (CHARTS.reportsMonthlyMelting) {
                CHARTS.reportsMonthlyMelting.data.labels = sortedMonths;
                CHARTS.reportsMonthlyMelting.data.datasets[0].data = sortedMonths.map(m => monthlyData[m]);
                CHARTS.reportsMonthlyMelting.update();
            }

            // --- 2. Purity Distribution Data ---
            const purityBins = { low: 0, medium: 0, high: 0 };
            jobs.forEach(job => {
                if (job.purity > 95) purityBins.high++;
                else if (job.purity >= 90) purityBins.medium++;
                else purityBins.low++;
            });

            // Update Chart 2
            if (CHARTS.reportsPurityDistribution) {
                CHARTS.reportsPurityDistribution.data.datasets[0].data = [purityBins.low, purityBins.medium, purityBins.high];
                CHARTS.reportsPurityDistribution.update();
            }

            // --- 3. Monthly Revenue Data ---
            const revenueData = jobs.filter(j => j.billed).reduce((acc, job) => {
                const monthYear = job.date.substring(0, 7);
                acc[monthYear] = (acc[monthYear] || 0) + job.charge;
                return acc;
            }, {});
            const sortedRevenueMonths = Object.keys(revenueData).sort();

            // Update Chart 3
            if (CHARTS.reportsMonthlyRevenue) {
                CHARTS.reportsMonthlyRevenue.data.labels = sortedRevenueMonths;
                CHARTS.reportsMonthlyRevenue.data.datasets[0].data = sortedRevenueMonths.map(m => revenueData[m]);
                CHARTS.reportsMonthlyRevenue.update();
            }
        }

        window.renderReports = () => {
            if (state.currentPage !== 'reports') return;

            const jobs = state.meltingJobs.map(ApiService._getJobCalculations).filter(j => j.status === 'Completed');
            const colors = getChartColors();

            // --- Chart 1: Monthly Melting Trend ---
            const monthlyData = jobs.reduce((acc, job) => {
                const monthYear = job.date.substring(0, 7); // YYYY-MM
                const netWeight = job.outputWeight || 0;
                acc[monthYear] = (acc[monthYear] || 0) + netWeight;
                return acc;
            }, {});
            const sortedMonths = Object.keys(monthlyData).sort();

            const ctx1 = $('#reports-monthly-melting').getContext('2d');
            if (CHARTS.reportsMonthlyMelting) CHARTS.reportsMonthlyMelting.destroy();
            CHARTS.reportsMonthlyMelting = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: sortedMonths,
                    datasets: [{
                        label: 'Net Output (g)',
                        data: sortedMonths.map(m => monthlyData[m]),
                        backgroundColor: colors.primary.replace('0.9', '0.2'),
                        borderColor: colors.primary.replace('0.9', '1'),
                        borderWidth: 3,
                        tension: 0.3,
                        pointRadius: 5,
                        fill: true,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { labels: { color: colors.chartTextColor } } },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Net Weight (g)', font: { family: 'Inter', size: 14 } },
                            ticks: { color: colors.chartTextColor, font: { family: 'Inter' } },
                            grid: { color: colors.chartGridColor }
                        },
                        x: {
                            ticks: { color: colors.chartTextColor, font: { family: 'Inter' } },
                            grid: { color: colors.chartGridColor }
                        }
                    }
                }
            });

            // --- Chart 2: Purity Distribution ---
            const purityBins = { low: 0, medium: 0, high: 0 };
            jobs.forEach(job => {
                if (job.purity > 95) purityBins.high++;
                else if (job.purity >= 90) purityBins.medium++;
                else purityBins.low++;
            });

            const ctx2 = $('#reports-purity-distribution').getContext('2d');
            if (CHARTS.reportsPurityDistribution) CHARTS.reportsPurityDistribution.destroy();
            CHARTS.reportsPurityDistribution = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: ['< 90% Purity', '90% - 95% Purity', '> 95% Purity'],
                    datasets: [{
                        data: [purityBins.low, purityBins.medium, purityBins.high],
                        backgroundColor: [
                            colors.orange, // Orange
                            colors.purple, // Purple
                            colors.secondary // Teal
                        ],
                        hoverOffset: 8,
                        borderColor: 'white',
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: { color: colors.chartTextColor, padding: 20, font: { family: 'Inter' } }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.raw !== null) {
                                        label += context.raw;
                                    }
                                    return label + ' Jobs';
                                }
                            }
                        }
                    },
                    layout: {
                        padding: 10
                    }
                }
            });

            // --- Chart 3: Monthly Revenue ---
            const revenueData = jobs.filter(j => j.billed).reduce((acc, job) => {
                const monthYear = job.date.substring(0, 7);
                acc[monthYear] = (acc[monthYear] || 0) + job.charge;
                return acc;
            }, {});
            const sortedRevenueMonths = Object.keys(revenueData).sort();

            const ctx3 = $('#reports-monthly-revenue').getContext('2d');
            if (CHARTS.reportsMonthlyRevenue) CHARTS.reportsMonthlyRevenue.destroy();
            CHARTS.reportsMonthlyRevenue = new Chart(ctx3, {
                type: 'bar',
                data: {
                    labels: sortedRevenueMonths,
                    datasets: [{
                        label: 'Total Revenue (â‚¹)',
                        data: sortedRevenueMonths.map(m => revenueData[m]),
                        backgroundColor: colors.purple, // Used purple for variation
                        borderColor: colors.purple.replace('0.9', '1'),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { labels: { color: colors.chartTextColor } } },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Revenue (â‚¹)', font: { family: 'Inter', size: 14 } },
                            ticks: { color: colors.chartTextColor, font: { family: 'Inter' } },
                            grid: { color: colors.chartGridColor }
                        },
                        x: {
                            ticks: { color: colors.chartTextColor, font: { family: 'Inter' } },
                            grid: { color: colors.chartGridColor }
                        }
                    }
                }
            });

            updateChartTheme();
        }

        window.renderNotifications = () => {
            if (state.currentPage !== 'notifications' && state.currentPage !== 'dashboard') return;

            const notifications = getRealTimeNotifications();
            const listContainer = $('#notifications-list');
            const emptyState = $('#notifications-empty-state');
            const badge = $('#notification-badge');

            // Update badge regardless of page
            if (notifications.length > 0) {
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }

            // Only render list if on the Notifications page
            if (state.currentPage !== 'notifications') return;

            // FIX: Added null check for listContainer and emptyState
            if (!listContainer || !emptyState) return;

            listContainer.innerHTML = ''; // Clear previous content

            if (notifications.length === 0) {
                emptyState.classList.remove('hidden');
                // Re-inject empty state HTML if it was cleared
                listContainer.innerHTML = `
                    <div id="notifications-empty-state" class="p-12 text-center">
                        <i data-lucide="check-circle" class="mx-auto h-12 w-12 text-green-500"></i>
                        <h3 class="mt-2 text-lg font-medium text-gray-900">All Clear!</h3>
                        <p class="mt-1 text-sm text-gray-600 font-inter">No pressing issues found in the system.</p>
                    </div>
                `;
                lucide.createIcons();
                return;
            } else {
                 emptyState.classList.add('hidden');
            }

            const notificationHtml = notifications.map(n => `
                <div class="flex items-start p-4 hover:bg-gray-50 transition-colors">
                    <i data-lucide="${n.icon}" class="h-6 w-6 ${n.color} flex-shrink-0 mt-1"></i>
                    <div class="ml-3 w-full">
                        <p class="text-base font-medium text-gray-900">${n.title}</p>
                        <p class="text-sm text-gray-600 font-inter">${n.message}</p>
                        <div class="mt-2 text-sm text-blue-600 cursor-pointer hover:text-blue-700 font-inter" onclick="showPage('${n.link}')">
                            Go to ${navLinks.find(l => l.page === n.link)?.label || 'Page'}
                        </div>
                    </div>
                </div>
            `).join('');

            listContainer.innerHTML = notificationHtml;
            lucide.createIcons();
        }

        function getRealTimeNotifications() {
            const alerts = [];
            const threshold = state.settings.lowStockThreshold;

            // 1. Pending Jobs
            const pendingJobs = state.meltingJobs.filter(j => j.status === 'Pending').length;
            if (pendingJobs > 0) {
                alerts.push({
                    icon: 'clock',
                    color: 'text-yellow-600',
                    title: `${pendingJobs} Melting Job${pendingJobs > 1 ? 's' : ''} Pending`,
                    message: `Please complete the remaining ${pendingJobs} melting jobs.`,
                    link: 'melting-records'
                });
            }

            // 2. Unpaid Bills
            const unbilledJobs = state.meltingJobs.filter(j => j.status === 'Completed' && !j.billed).length;
            if (unbilledJobs > 0) {
                 alerts.push({
                    icon: 'receipt',
                    color: 'text-red-600',
                    title: `${unbilledJobs} Job${unbilledJobs > 1 ? 's' : ''} Ready for Billing`,
                    message: `There are ${unbilledJobs} completed jobs that need to be billed to vendors.`,
                    link: 'billing'
                });
            }

            // 3. Low Inventory
            const lowStockItems = state.inventory.filter(i => i.quantity <= threshold);
            if (lowStockItems.length > 0) {
                 alerts.push({
                    icon: 'package-open',
                    color: 'text-red-500',
                    title: `${lowStockItems.length} Inventory Item${lowStockItems.length > 1 ? 's' : ''} Low`,
                    message: `Items like ${lowStockItems.map(i => i.itemType).slice(0, 3).join(', ')} are below the stock threshold of ${threshold}.`,
                    link: 'inventory'
                });
            }

            return alerts;
        }

        window.renderUserMgmt = () => {
             if (state.currentPage !== 'user-mgmt') return;

             const users = ApiService.getUserManagementData();
             const tableBody = $('#user-mgmt-table-body');
             const emptyState = $('#user-mgmt-empty-state');
             const currentUserId = auth.currentUser.uid;

             if (users.length === 0) {
                tableBody.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            tableBody.innerHTML = users.map((u, index) => {
                const isActive = u.isActive || false;
                const statusColor = isActive ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                const statusText = isActive ? 'Active' : 'Inactive';
                const actionIcon = isActive ? 'lock' : 'unlock';
                const isDisabled = u.userId === currentUserId;

                return `
                    <tr id="row-${u.id}" class="${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'} hover:bg-gray-100 transition-colors duration-150">
                        <td class="px-6 py-4 whitespace-nowrap text-base font-medium text-gray-900">${u.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-base text-gray-600 font-inter">${u.id.substring(0, 8)}...</td>
                        <td class="px-6 py-4 whitespace-nowrap text-base">
                            <span class="px-2 inline-flex text-sm leading-5 font-semibold rounded-full ${statusColor} font-inter">${statusText}</span>
                        </td>
                         <td class="px-6 py-4 whitespace-nowrap text-base text-gray-600 font-inter">${u.role}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button class="action-toggle-status text-yellow-600 hover:text-yellow-700 p-1 rounded-2xl transition-colors ${isDisabled ? 'opacity-50 cursor-not-allowed' : ''}"
                                data-id="${u.id}" data-status="${isActive}"
                                title="${isActive ? 'Deactivate User' : 'Activate User'}" ${isDisabled ? 'disabled' : ''}>
                                <i data-lucide="${actionIcon}" class="w-4 h-4"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
            lucide.createIcons();
        }

        // ==========================================================
        // AUTHENTICATION HANDLERS
        // ==========================================================

        // (Authentication handlers remain the same)
        async function handleLogin(e) {
            e.preventDefault();
            loginError.textContent = '';
            showSpinner(true);

            const email = $('#login-email').value;
            const password = $('#login-password').value;

            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                console.error("Login error:", error.code, error.message);
                if (error.code === 'auth/invalid-credential' || error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found') {
                    loginError.textContent = "Invalid email or password.";
                } else {
                    loginError.textContent = "Login failed. Please try again.";
                }
            } finally {
                showSpinner(false);
            }
        }

        async function handleSignUp(e) {
            e.preventDefault();
            signupError.textContent = '';
            showSpinner(true);

            const name = $('#signup-name').value;
            const email = $('#signup-email').value;
            const password = $('#signup-password').value;

            if (password.length < 6) {
                signupError.textContent = "Password must be at least 6 characters long.";
                showSpinner(false);
                return;
            }

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                await updateProfile(userCredential.user, {
                    displayName: name
                });
                console.log("New user created and profile updated.");
            } catch (error) {
                console.error("Sign up error:", error.code, error.message);
                if (error.code === 'auth/email-already-in-use') {
                    signupError.textContent = "This email is already in use.";
                } else if (error.code === 'auth/weak-password') {
                    signupError.textContent = "Password is too weak. Please use at least 6 characters.";
                } else if (error.code === 'auth/invalid-email') {
                    signupError.textContent = "Please enter a valid email address.";
                } else {
                    signupError.textContent = "Could not create account. Please ensure Email/Password auth is enabled in your Firebase project.";
                }
            } finally {
                showSpinner(false);
            }
        }

        async function handleForgotPassword(e) {
            e.preventDefault();
            forgotError.textContent = '';
            forgotSuccess.textContent = '';
            showSpinner(true);

            const email = $('#forgot-email').value;

            try {
                await sendPasswordResetEmail(auth, email);
                forgotSuccess.textContent = "Password reset link sent! Check your email.";
            } catch (error) {
                console.error("Forgot password error:", error.code, error.message);
                forgotError.textContent = "Could not send reset link. Is the email correct?";
            } finally {
                showSpinner(false);
            }
        }

        async function handleSettingsSave(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = {
                meltingChargePerKg: parseFloat(formData.get('meltingChargePerKg')),
                lowStockThreshold: parseInt(formData.get('lowStockThreshold'))
            };

            if (isNaN(data.meltingChargePerKg) || data.meltingChargePerKg < 0) {
                showToast("Please enter a valid, positive charge amount.", 'error');
                return;
            }
            if (isNaN(data.lowStockThreshold) || data.lowStockThreshold < 0) {
                showToast("Please enter a valid, non-negative threshold quantity.", 'error');
                return;
            }

            try {
                await ApiService.saveSettings(data);
            } catch (error) {
                console.error('Settings save error:', error);
                showToast(error.message, 'error');
            }
        }

        async function handleProfileNameSave(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const newName = formData.get('displayName');

            if (!newName || newName.trim() === '') {
                showToast("Name cannot be empty.", 'error');
                return;
            }

            showSpinner(true);
            try {
                await updateProfile(auth.currentUser, {
                    displayName: newName
                });

                // Manually update UI elements
                userName.textContent = newName;
                $('#profile-name-display').textContent = newName;
                userAvatar.src = `https://placehold.co/40x40/2563eb/ffffff?text=${(newName || 'A').charAt(0).toUpperCase()}`;
                $('#profile-avatar-img').src = `https://placehold.co/96x96/2563eb/ffffff?text=${(newName || 'A').charAt(0).toUpperCase()}`;

                showToast('Profile name updated!', 'success');
            } catch (error) {
                console.error('Profile update error:', error);
                showToast(error.message, 'error');
            } finally {
                showSpinner(false);
            }
        }

        async function handleChangePassword() {
            passwordResetSuccess.classList.add('hidden');
            showSpinner(true);
            try {
                await sendPasswordResetEmail(auth, auth.currentUser.email);
                passwordResetSuccess.textContent = "Password reset link sent! Check your email.";
                passwordResetSuccess.classList.remove('hidden');
            } catch (error) {
                console.error("Password reset error:", error);
                showToast(error.message, 'error');
            } finally {
                showSpinner(false);
            }
        }

        function showAuthForm(formToShow) {
            authLoader.classList.add('hidden');
            loginForm.classList.add('hidden');
            signupForm.classList.add('hidden');
            forgotPasswordForm.classList.add('hidden');

            if (formToShow === 'login') {
                loginForm.classList.remove('hidden');
            } else if (formToShow === 'signup') {
                signupForm.classList.remove('hidden');
            } else if (formToShow === 'forgot') {
                forgotPasswordForm.classList.remove('hidden');
            } else if (formToShow === 'loader') {
                authLoader.classList.remove('hidden');
            }
        }

        // ==========================================================
        // EVENT LISTENERS
        // ==========================================================

        loginForm.addEventListener('submit', handleLogin);
        signupForm.addEventListener('submit', handleSignUp);
        forgotPasswordForm.addEventListener('submit', handleForgotPassword);
        settingsForm.addEventListener('submit', handleSettingsSave);
        profileNameForm.addEventListener('submit', handleProfileNameSave);
        profileChangePasswordButton.addEventListener('click', handleChangePassword);

        showSignupButton.addEventListener('click', (e) => { e.preventDefault(); showAuthForm('signup'); });
        showLoginButton.addEventListener('click', (e) => { e.preventDefault(); showAuthForm('login'); });
        showForgotPasswordButton.addEventListener('click', (e) => { e.preventDefault(); showAuthForm('forgot'); });
        showLoginFromForgotButton.addEventListener('click', (e) => { e.preventDefault(); showAuthForm('login'); });

        logoutButton.addEventListener('click', () => {
            signOut(auth).catch(error => {
                console.error("Error signing out: ", error);
                showToast(error.message, 'error');
            });
        });

        modalForm.addEventListener('submit', handleFormSubmit);
        modalCloseButton.addEventListener('click', closeModal);
        modalCancelButton.addEventListener('click', closeModal);
        deleteCancelButton.addEventListener('click', closeDeleteModal);
        deleteConfirmButton.addEventListener('click', handleDeleteConfirm);

        billModalCloseButton.addEventListener('click', () => {
            billModal.classList.remove('open');
            billModal.classList.add('opacity-0', 'pointer-events-none');
            renderBillingTable(billingVendorSelect.value);
        });

        billPdfButton.addEventListener('click', downloadBillAsPDF);

        // NEW: Print Bill Button Listener
        billPrintBrowserButton.addEventListener('click', () => {
            // Open the bill modal content in a new window for printing
            const printContents = document.getElementById('bill-print-area').innerHTML;
            const originalContents = document.body.innerHTML;

            // Temporarily replace body content to trigger print styles
            document.body.innerHTML = printContents;
            window.print();

            // Restore original body content
            document.body.innerHTML = originalContents;
            // A reload is safer for restoring DOM and JS state, though intrusive
            window.location.reload();
        });

        // CSV Export Listener
        document.getElementById('page-vendors').addEventListener('click', (e) => {
            if (e.target.closest('#vendor-export-csv-button')) {
                const button = e.target.closest('#vendor-export-csv-button');
                const type = button.dataset.type;
                downloadCSVExport(type);
            }
        });
        document.getElementById('page-melting-records').addEventListener('click', (e) => {
            if (e.target.closest('#jobs-export-csv-button')) {
                const button = e.target.closest('#jobs-export-csv-button');
                const type = button.dataset.type;
                downloadCSVExport(type);
            }
        });

        mainApp.addEventListener('click', async (e) => {
            // Use .closest() to catch clicks on icons inside buttons
            const editButton = e.target.closest('.action-edit');
            const completeButton = e.target.closest('.action-complete');
            const deleteButton = e.target.closest('.action-delete');
            const toggleStatusButton = e.target.closest('.action-toggle-status');

            if (editButton) {
                openModal(editButton.dataset.type, editButton.dataset.id);
            }
            if (completeButton) {
                openModal(completeButton.dataset.type, completeButton.dataset.id);
            }
            if (deleteButton) {
                let deleteFn;
                switch(deleteButton.dataset.type) {
                    case 'vendor': deleteFn = ApiService.deleteVendor; break;
                    case 'meltingJob': deleteFn = ApiService.deleteMeltingJob; break;
                    case 'inventoryItem': deleteFn = ApiService.deleteInventory; break;
                    case 'purchaseOrder': deleteFn = ApiService.deletePurchaseOrder; break;
                }
                openDeleteModal(deleteButton.dataset.id, deleteFn);
            }
            if (toggleStatusButton) {
                const id = toggleStatusButton.dataset.id;
                const status = toggleStatusButton.dataset.status === 'true';
                try {
                    await ApiService.toggleUserActiveStatus(id, status);
                } catch (error) {
                    showToast(error.message, 'error');
                }
            }
        });

        vendorSearch.addEventListener('input', () => { renderVendors(); });
        inventorySearch.addEventListener('input', () => { renderInventory(); });
        poSearch.addEventListener('input', () => { renderPurchaseorders(); });
        purityFilter.addEventListener('change', () => { renderMeltingrecords(); });

        billingVendorSelect.addEventListener('change', (e) => {
            renderBillingTable(e.target.value);
        });

        billingJobsSection.addEventListener('change', (e) => {
            if (e.target.id === 'bill-select-all') {
                $$('.bill-job-checkbox').forEach(box => {
                    box.checked = e.target.checked;
                });
            }
            updateBillingTotal();
        });

        generateBillButton.addEventListener('click', openBillModal);

        // Mobile Sidebar Toggle (FIXED: Moved to end of file, inside module script, no redeclarations needed)
        if (sidebarToggleMobile) {
            sidebarToggleMobile.addEventListener('click', () => {
                sidebar.classList.toggle('open');
                mobileSidebarOverlay.classList.toggle('hidden');
            });
        }
        if (mobileSidebarOverlay) {
             mobileSidebarOverlay.addEventListener('click', () => {
                sidebar.classList.remove('open');
                mobileSidebarOverlay.classList.add('hidden');
            });
        }
        

        // Chart.js Canvas Resize 
        window.addEventListener('resize', () => {
            if (window.Chart && window.Chart.instances) {
                window.Chart.helpers.each(window.Chart.instances, function(instance){
                    instance.resize();
                });
            }
        });


        // ==========================================================
        // EXPORT FUNCTIONS (CSV and PDF)
        // ==========================================================

        function downloadCSVExport(type) {
            try {
                const { headers, data } = ApiService.getExportData(type);
                if (data.length === 0) {
                    showToast("No data to export.", 'info');
                    return;
                }

                const csvContent = [
                    headers.join(','),
                    ...data.map(row => row.map(field => JSON.stringify(field)).join(','))
                ].join('\n');

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                const date = new Date().toISOString().split('T')[0];

                link.setAttribute("href", url);
                link.setAttribute("download", `${type}_report_${date}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showToast(`${type} data exported successfully!`, 'success');

            } catch (error) {
                console.error("CSV export error:", error);
                showToast(`Failed to export CSV: ${error.message}`, 'error');
            }
        }

        async function openBillModal() {
            const vendorId = billingVendorSelect.value;
            const vendor = state.vendors.find(v => v.id === vendorId);
            const checkedBoxes = $$('.bill-job-checkbox:checked');
            const jobIds = Array.from(checkedBoxes).map(box => box.dataset.jobId);
            const allJobs = ApiService.getMeltingJobs();

            const jobsToBill = allJobs.filter(j => jobIds.includes(j.id));

            let totalNet = 0;
            let totalGross = 0;
            let totalCharge = 0;

            $('#bill-items-table').innerHTML = jobsToBill.map(j => {
                totalGross += j.grossWeight;
                totalNet += (j.outputWeight || 0);
                totalCharge += j.charge;
                return `
                    <tr class="text-black">
                        <td class="px-3 py-3.5 text-left text-base text-gray-600 font-inter">${j.date}</td>
                        <td class="px-3 py-3.5 text-left text-base text-gray-600 font-inter">${j.itemType}</td>
                        <td class="px-3 py-3.5 text-right text-base text-gray-600 font-inter">${ApiService._formatGrams(j.grossWeight)}</td>
                        <td class="px-3 py-3.5 text-right text-base text-gray-600 font-inter">${ApiService._formatGrams(j.outputWeight)}</td>
                        <td class="px-3 py-3.5 text-right text-base font-medium text-gray-800 font-inter">${ApiService._formatCurrency(j.charge)}</td>
                    </tr>
                `;
            }).join('');

            $('#bill-id').textContent = `B-${Date.now().toString().slice(-6)}`;
            $('#bill-date').textContent = new Date().toLocaleDateString('en-IN');
            $('#bill-vendor-name-display').textContent = vendor.name;
            $('#bill-vendor-phone').textContent = vendor.mobile;
            $('#bill-vendor-address').textContent = vendor.address;

            $('#bill-total-gross').textContent = ApiService._formatGrams(totalGross);
            $('#bill-total-net').textContent = ApiService._formatGrams(totalNet);
            $('#bill-melting-charge').textContent = `(Charge @ â‚¹${state.settings.meltingChargePerKg}/kg)`;
            $('#bill-total-charge-display').textContent = ApiService._formatCurrency(totalCharge);

            try {
                await ApiService.markJobsAsBilled(jobIds, vendor.name);
                billModal.classList.add('open');
                billModal.classList.remove('opacity-0', 'pointer-events-none');
            } catch (error) {
                console.error("Error marking jobs as billed:", error);
                showToast(error.message, 'error');
            }
        }

        async function downloadBillAsPDF() {
            if (!html2pdf) {
                showToast("Error: PDF library (html2pdf.js) is not loaded.", 'error');
                return;
            }

            const element = document.getElementById('bill-print-area');
            const billId = $('#bill-id').textContent;
            const vendorName = $('#bill-vendor-name-display').textContent.replace(/ /g, '_');
            const date = $('#bill-date').textContent.replace(/\//g, '-');
            const fileName = `Melting_Bill_${vendorName}_${date}_${billId}.pdf`;
            const pdfButton = $('#bill-pdf-button');

            pdfButton.disabled = true;
            pdfButton.innerHTML = `<i data-lucide="loader" class="w-5 h-5 mr-2 animate-spin"></i> Generating...`;
            lucide.createIcons();

            // Prepare configuration for accurate A4 printing
            const opt = {
                margin: 10,
                filename: fileName,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: {
                    scale: 3, // High DPI capture
                    letterRendering: true,
                    useCORS: true,
                    allowTaint: true,
                    scrollY: 0,
                    windowWidth: 794 // Approximate A4 width in px at 96 DPI
                },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            // Wait briefly to ensure DOM updates and styles are finalized
            await new Promise(resolve => setTimeout(resolve, 300));

            try {
                // Generate PDF
                await html2pdf().set(opt).from(element).save();

                showToast("Bill downloaded as PDF successfully!", 'success');

            } catch (err) {
                console.error("Error generating PDF:", err);
                showToast("Error generating PDF. Please ensure all data is visible on screen and try again.", 'error');
            } finally {
                // Restore button state
                pdfButton.disabled = false;
                pdfButton.innerHTML = `<i data-lucide="download" class="w-5 h-5 mr-2"></i> Download PDF`;
                lucide.createIcons();
            }
        }


        // ==========================================================
        // FIRESTORE REAL-TIME LISTENERS
        // ==========================================================

        function detachFirestoreListeners() {
            if (state.unsubVendors) state.unsubVendors();
            if (state.unsubJobs) state.unsubJobs();
            if (state.unsubSettings) state.unsubSettings();
            if (state.unsubInventory) state.unsubInventory(); // NEW
            if (state.unsubPurchaseOrders) state.unsubPurchaseOrders(); // NEW
            if (state.unsubAppUsers) state.unsubAppUsers(); // NEW

            state.unsubVendors = null;
            state.unsubJobs = null;
            state.unsubSettings = null;
            state.unsubInventory = null;
            state.unsubPurchaseOrders = null;
            state.unsubAppUsers = null;

            state.vendors = [];
            state.meltingJobs = [];
            state.inventory = [];
            state.purchaseOrders = [];
            state.appUsers = [];
            state.settings = { meltingChargePerKg: 15.00, lowStockThreshold: 10 };
        }

        function updateRender(pageId, dataArray, name) {
            const renderFn = `render${pageId.charAt(0).toUpperCase() + pageId.slice(1).replace(/-/g, '')}`;

            // 1. Update lists if on the related page
            if (state.currentPage === pageId && window[renderFn]) {
                window[renderFn]();
            }

            // 2. Always update components relying on ALL data
            if (window.renderDashboard) window.renderDashboard();
            if (window.renderReports) {
                // Update charts data and redraw without re-initializing the component
                updateReportCharts();
            }
            if (window.renderNotifications) window.renderNotifications();
            if (window.renderProfile) window.renderProfile();

            // 3. Special case for billing, check if the selected vendor data changed
            if (state.currentPage === 'billing' && (name === 'vendors' || name === 'meltingJobs')) {
                 renderBillingTable(billingVendorSelect.value);
            }
        }

        function attachFirestoreListeners() {
            if (!state.userId) { console.error("Cannot attach listeners: User ID missing."); return; }

            const listeners = [
                { pageId: 'vendors', name: 'vendors', colRef: ApiService._getVendorsColRef(), stateKey: 'vendors', unsubKey: 'unsubVendors' },
                { pageId: 'melting-records', name: 'meltingJobs', colRef: ApiService._getJobsColRef(), stateKey: 'meltingJobs', unsubKey: 'unsubJobs' },
                { pageId: 'inventory', name: 'inventory', colRef: ApiService._getInventoryColRef(), stateKey: 'inventory', unsubKey: 'unsubInventory' }, // NEW
                { pageId: 'purchase-orders', name: 'purchaseOrders', colRef: ApiService._getPurchaseOrdersColRef(), stateKey: 'purchaseOrders', unsubKey: 'unsubPurchaseOrders' }, // NEW
                { pageId: 'user-mgmt', name: 'appUsers', colRef: ApiService._getUsersColRef(), stateKey: 'appUsers', unsubKey: 'unsubAppUsers' }, // NEW (Simulated)
            ];

            listeners.forEach(config => {
                if (!config.colRef) return;

                state[config.unsubKey] = onSnapshot(query(config.colRef), (querySnapshot) => {
                    const data = [];
                    querySnapshot.forEach((doc) => {
                        data.push({ id: doc.id, ...doc.data() });
                    });
                    state[config.stateKey] = data;
                    console.log(`Updated ${config.name} state:`, data.length);

                    // Call the unified update render function
                    updateRender(config.pageId, data, config.name);

                }, (error) => {
                    console.error(`Error listening to ${config.name}:`, error.message);
                    if (error.code !== 'permission-denied') {
                        showToast(`Error loading ${config.name} data.`, "error");
                    }
                });
            });

            // Settings Listener (Doc specific)
            const settingsDocRef = ApiService._getSettingsDocRef();
            if (settingsDocRef) {
                state.unsubSettings = onSnapshot(settingsDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        state.settings = { ...state.settings, ...docSnap.data() };
                    } else {
                        // If doc doesn't exist, save defaults immediately
                        ApiService.saveSettings(state.settings).catch(e => console.error("Failed to save default settings", e));
                    }
                    updateRender('settings');
                    updateChartTheme(); // Ensure charts update immediately if colors rely on settings
                }, (error) => {
                    console.error("Error listening to settings:", error);
                    if (error.code !== 'permission-denied') {
                        showToast("Error loading settings.", "error");
                    }
                });
            }
        }

        // ==========================================================
        // LOGIN PAGE 3D ANIMATION (THREE.js)
        // ==========================================================
        function init3DBackground() {
            const canvas = document.getElementById('three-canvas');
            if (!canvas) return;

            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            const renderer = new THREE.WebGLRenderer({ canvas, antialias: true, alpha: true });

            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setClearColor(0x000000, 0); // Transparent background

            // Lighting (Ambient light + focused blue/amber light for thematic glow)
            const ambientLight = new THREE.AmbientLight(0x404040, 5); // soft white light
            scene.add(ambientLight);

            const pointLight = new THREE.PointLight(0x2563eb, 30); // Blue light
            pointLight.position.set(5, 5, 5);
            scene.add(pointLight);

            const pointLight2 = new THREE.PointLight(0xffa500, 15); // Amber/Gold light
            pointLight2.position.set(-5, -5, 5);
            scene.add(pointLight2);

            // Silver/Metallic Geometry (Torus Knots for complex, industrial look)
            const geometry = new THREE.TorusKnotGeometry(2, 0.5, 150, 16);
            const material = new THREE.MeshPhongMaterial({
                color: 0xcccccc, // Silver color
                specular: 0xffffff, // High reflectivity
                shininess: 100,
                flatShading: true
            });
            const mesh = new THREE.Mesh(geometry, material);
            scene.add(mesh);

            camera.position.z = 8;

            let mouseX = 0;
            let mouseY = 0;

            document.addEventListener('mousemove', (event) => {
                mouseX = (event.clientX / window.innerWidth) * 2 - 1;
                mouseY = -(event.clientY / window.innerHeight) * 2 + 1;
            });

            function animate() {
                if (loginScreen.classList.contains('hidden')) {
                    // Stop animation loop when app starts
                    renderer.dispose();
                    return;
                }

                requestAnimationFrame(animate);

                // Auto-rotation
                mesh.rotation.x += 0.005;
                mesh.rotation.y += 0.008;

                // Subtle parallax effect based on mouse movement
                mesh.rotation.x += mouseY * 0.001;
                mesh.rotation.y += mouseX * 0.001;

                // Animate lights to enhance metallic reflections
                const time = Date.now() * 0.001;
                pointLight.position.x = Math.sin(time * 0.7) * 9;
                pointLight.position.y = Math.cos(time * 0.5) * 9;
                pointLight2.position.x = Math.cos(time * 0.6) * 7;
                pointLight2.position.y = Math.sin(time * 0.4) * 7;


                renderer.render(scene, camera);
            }

            function onWindowResize() {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            }

            window.addEventListener('resize', onWindowResize);
            animate();
        }


        // ==========================================================
        // INITIALIZATION
        // ==========================================================
        async function init() {
            // --- 1. Set up theme immediately ---
            initTheme();

            // --- 2. Show login screen and loader ---
            loginScreen.classList.remove('hidden');
            showAuthForm('loader');

            // --- 3. Render all Lucide icons on the page ---
            lucide.createIcons();

            // --- 5. Firebase Init (Using user provided config) ---
            const USER_FIREBASE_CONFIG = {
                apiKey: "AIzaSyCm_tAiQNKZTR_-g_mJFs4r-ykA7JAp2gs",
                authDomain: "constant-setup-419208.firebaseapp.com",
                projectId: "constant-setup-419208",
                storageBucket: "constant-setup-419208.firebasestorage.app",
                messagingSenderId: "964058460374",
                appId: "1:964058460374:web:9987c68ac3ac4e34ad9977",
                measurementId: "G-S51SSNWFX7"
            };

            let firebaseConfig;
            try {
                if (typeof __firebase_config === 'undefined' || !__firebase_config) {
                    throw new Error("__firebase_config is not defined.");
                }
                firebaseConfig = JSON.parse(__firebase_config);
                console.log("Using environment Firebase config.");
            } catch (error) {
                console.warn(error.message);
                console.warn("Using user-provided Firebase config for local development.");
                firebaseConfig = USER_FIREBASE_CONFIG;
                if (state.appId === 'default-app-id') {
                    state.appId = firebaseConfig.appId || 'default-app-id';
                }
            }

            try {
                app = initializeApp(firebaseConfig);
                const analytics = getAnalytics(app);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('debug');

                init3DBackground(); // Start 3D animation immediately

                // --- 6. Auth State Change Listener ---
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        console.log("User is signed in:", user.uid);
                        state.userId = user.uid;
                        state.isAuthReady = true;

                        userName.textContent = user.displayName || "Administrator";
                        userAvatar.src = user.photoURL || `https://placehold.co/40x40/2563eb/ffffff?text=${(user.displayName || 'A').charAt(0).toUpperCase()}`;
                        userIdDisplay.textContent = user.uid;

                        await ApiService.setupInitialUser(user);

                        attachFirestoreListeners();

                        loginScreen.classList.add('hidden');
                        mainApp.classList.remove('hidden');
                        mainApp.classList.add('h-full');
                        buildSidebar();
                        showPage('dashboard');

                    } else {
                        console.log("User is signed out.");
                        state.userId = null;
                        state.isAuthReady = false;

                        detachFirestoreListeners();

                        loginScreen.classList.remove('hidden');
                        mainApp.classList.add('hidden');
                        mainApp.classList.remove('h-full');

                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            try {
                                await signInWithCustomToken(auth, __initial_auth_token);
                            } catch (tokenError) {
                                console.error("Custom token sign-in failed:", tokenError);
                                showAuthForm('login');
                                if (loginError) loginError.textContent = "Session invalid. Please sign in.";
                            }
                        } else {
                            await signInAnonymously(auth).catch(anonError => {
                                console.error("Anonymous sign-in failed:", anonError);
                                showAuthForm('login');
                                if (loginError) loginError.textContent = "Sign-in required.";
                            });
                        }
                    }
                });

            } catch (error) {
                console.error("Failed to initialize Firebase:", error);
                showAuthForm('login');
                if (loginError) loginError.textContent = `Error: ${error.message}`;
            }
        }

        init();
    });
    </script>
</body>
</html>
